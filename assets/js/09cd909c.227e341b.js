"use strict";(self.webpackChunksilta_docs=self.webpackChunksilta_docs||[]).push([[724],{1775:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>o,contentTitle:()=>r,default:()=>h,frontMatter:()=>l,metadata:()=>t,toc:()=>d});const t=JSON.parse('{"id":"gcp_filestore_migration","title":"Replace file storage with Google\'s Filestore volume.","description":"This example will change storage for Drupal public files.","source":"@site/docs/gcp_filestore_migration.md","sourceDirName":".","slug":"/gcp_filestore_migration","permalink":"/silta/docs/gcp_filestore_migration","draft":false,"unlisted":false,"editUrl":"https://github.com/wunderio/silta/tree/master/docs/gcp_filestore_migration.md","tags":[],"version":"current","frontMatter":{}}');var i=s(4848),a=s(8453);const l={},r="Replace file storage with Google's Filestore volume.",o={},d=[{value:"!! LIMITATIONS, PITFALLS",id:"-limitations-pitfalls",level:3},{value:"Changing storage for an existing environment:",id:"changing-storage-for-an-existing-environment",level:2},{value:"Changing storage for a new deployment, project:",id:"changing-storage-for-a-new-deployment-project",level:2}];function c(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",...(0,a.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"replace-file-storage-with-googles-filestore-volume",children:"Replace file storage with Google's Filestore volume."})}),"\n",(0,i.jsx)(n.p,{children:"This example will change storage for Drupal public files.\nRepeat the same steps for other volumes, such as private files."}),"\n",(0,i.jsxs)(n.p,{children:["This will first add a new mount for the new Google filestore to ",(0,i.jsx)(n.code,{children:"/app/web/sites/default/files-new"})," where the files from the existing object storage ",(0,i.jsx)(n.code,{children:"public-files"})," mount ",(0,i.jsx)(n.code,{children:"/app/web/sites/default/files"})," are copied from and then the new filestore is mounted to the existing ",(0,i.jsx)(n.code,{children:"/app/web/sites/default/files"})," mount at the same time when the old ",(0,i.jsx)(n.code,{children:"public-files"})," mount is disabled."]}),"\n",(0,i.jsx)(n.h3,{id:"-limitations-pitfalls",children:"!! LIMITATIONS, PITFALLS"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"Do not delete the old public-files section, nor change their names. Kubernetes tracks the volumes by these names."}),"\n",(0,i.jsx)(n.li,{children:"Do not change storage size after the first deployment. You will end up in an error state: Ignoring the PVC: didn't find a plugin capable of expanding the volume; waiting for an external controller to process this PVC."}),"\n",(0,i.jsx)(n.li,{children:"The provisioned storage limit is not enforced. The application can expand to use all the available storage regardless of the provisioned size.\nIf you run out of free space on volume, contact cluster administrator for its expansion."}),"\n",(0,i.jsx)(n.li,{children:"The provisioned storage is not guaranteed. You may allocate more than the NFS share's total size. The share may also not have enough storage space left to actually accommodate the request."}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"changing-storage-for-an-existing-environment",children:"Changing storage for an existing environment:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Add a new location which uses the new storage. We will extend default values from ",(0,i.jsx)(n.a,{href:"https://github.com/wunderio/charts/blob/039f29d9d507813d40a182fa2320adfd6a3db06a/drupal/values.yaml#L355",children:"https://github.com/wunderio/charts/blob/039f29d9d507813d40a182fa2320adfd6a3db06a/drupal/values.yaml#L355"})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"mounts:\n  public-files-filestore:\n    enabled: true\n    storage: 10G\n    mountPath: /app/web/sites/default/files-new\n    storageClassName: nfs-shared\n"})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Deploy"}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Find and exec into the shell deployment to get root access"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"kubectl --namespace=<namespace> get deployments | grep shell\nkubectl --namespace=<namespace> exec -it deployment/<shell deployment name> -- sh\n"})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Copy public files from the old location to the new one"}),"\n",(0,i.jsx)(n.p,{children:"4.1. Simple way, for small amounts of files:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"rsync --info=progress2 -az /app/web/sites/default/files/ /app/web/sites/default/files-new/\n"})}),"\n",(0,i.jsx)(n.p,{children:"4.2. Advanced way, for large amounts of files:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"cd /app/web/sites/default/files\nfind . -maxdepth 2 -mindepth 2 -type d | xargs -P15 -I% rsync --relative --info=progress2 -az % /app/web/sites/default/files-new/ \\\n  && find . -maxdepth 2 -mindepth 2 -type f  | xargs -P15 -I% rsync --relative --info=progress2 -az % /app/web/sites/default/files-new/ \\\n  && find . -maxdepth 1 -mindepth 1 -type f  | xargs -P15 -I% rsync --relative --info=progress2 -az % /app/web/sites/default/files-new/\n\n# Verify file count matches in both directories\nfind /app/web/sites/default/files/ | wc -l \\\n  && find /app/web/sites/default/files-new/ | wc -l\n"})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Set ownership and permissions for the new location"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'dir=/app/web/sites/default/files-new\nchown -R www-data:www-data "$dir"\nchmod 770 "$dir"\nfind "$dir" -type d -print0 | xargs -0 --max-args=100 chmod 770\nfind "$dir" -type f -print0 | xargs -0 --max-args=100 chmod 660\n'})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Update the mount path for the new mount, disable the old one"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"mounts:\n  public-files-filestore:\n    enabled: true\n    storage: 10G\n    mountPath: /app/web/sites/default/files\n    storageClassName: nfs-shared\n  public-files:\n    enabled: false\n    mountPath: /app/web/sites/default/files-old\n"})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Add the original Drupal file paths as environment variables (ignore the private files path if the project doesn't have private file system enabled)"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"php:\n  env:\n    PRIVATE_FILES_PATH: /app/private\n    PUBLIC_FILES_PATH: /app/web/sites/default/files\n"})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["To run PHP as user ",(0,i.jsx)(n.code,{children:"www-data"}),", add this line in your ",(0,i.jsx)(n.code,{children:"silta/php.Dockerfile"})," right after the ",(0,i.jsx)(n.code,{children:"COPY"})," line"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-dockerfile",children:"USER www-data\n"})}),"\n",(0,i.jsx)(n.p,{children:"Dockerfile example of a project"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-dockerfile",children:"FROM wunderio/silta-php-fpm:8.0-fpm-v1\n\nCOPY --chown=www-data:www-data . /app\n\nUSER www-data\n"})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Deploy"}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Check owners of the files directory, it should be www-data"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"ls -alh /app/web/sites/default/files\n"})}),"\n",(0,i.jsx)(n.p,{children:"If some of the files are owned by root - rerun step 5, but for the files path (not files-new)"}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Check that the public files path shows up correctly when running ",(0,i.jsx)(n.code,{children:"drush status"}),".\nIf it doesn't, make sure that it has not been overridden in settings.php file."]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"changing-storage-for-a-new-deployment-project",children:"Changing storage for a new deployment, project:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"Redefine the default public and private files volumes."}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"mounts:\n  public-files:\n    enabled: true\n    storage: 10G\n    mountPath: /app/web/sites/default/files\n    storageClassName: nfs-shared\n  private-files:\n    enabled: true\n    storage: 1G\n    mountPath: /app/private\n    storageClassName: nfs-shared\n"})}),"\n",(0,i.jsxs)(n.ol,{start:"2",children:["\n",(0,i.jsx)(n.li,{children:"Deploy - this is your first deployment for the project or environment."}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}},8453:(e,n,s)=>{s.d(n,{R:()=>l,x:()=>r});var t=s(6540);const i={},a=t.createContext(i);function l(e){const n=t.useContext(a);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:l(e.components),t.createElement(a.Provider,{value:n},e.children)}}}]);