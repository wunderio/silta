"use strict";(self.webpackChunksilta_docs=self.webpackChunksilta_docs||[]).push([[234],{8453:(e,i,n)=>{n.d(i,{R:()=>s,x:()=>a});var o=n(6540);const t={},l=o.createContext(t);function s(e){const i=o.useContext(l);return o.useMemo(function(){return"function"==typeof e?e(i):{...i,...e}},[i,e])}function a(e){let i;return i=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:s(e.components),o.createElement(l.Provider,{value:i},e.children)}},9131:(e,i,n)=>{n.r(i),n.d(i,{assets:()=>r,contentTitle:()=>a,default:()=>h,frontMatter:()=>s,metadata:()=>o,toc:()=>c});const o=JSON.parse('{"id":"anatomy-of-silta","title":"Silta project build process","description":"A silta project requires two main configuration files, which give you the possibility to customize the behavior according to your requirements:","source":"@site/docs/anatomy_of_a_silta_project.md","sourceDirName":".","slug":"/anatomy-of-silta","permalink":"/silta/docs/anatomy-of-silta","draft":false,"unlisted":false,"editUrl":"https://github.com/wunderio/silta/tree/master/docs/anatomy_of_a_silta_project.md","tags":[],"version":"current","frontMatter":{"id":"anatomy-of-silta","title":"Silta project build process"},"sidebar":"someSidebar","next":{"title":"CircleCI configuration examples","permalink":"/silta/docs/circleci-conf-examples"}}');var t=n(4848),l=n(8453);const s={id:"anatomy-of-silta",title:"Silta project build process"},a=void 0,r={},c=[{value:"CircleCI configuration",id:"circleci-configuration",level:2},{value:"Silta-configuration",id:"silta-configuration",level:2},{value:"Additional files",id:"additional-files",level:2},{value:"Dockerfiles",id:"dockerfiles",level:3},{value:".dockerignore",id:"dockerignore",level:3},{value:"Silta production configuration",id:"silta-production-configuration",level:3},{value:"settings.silta.php",id:"settingssiltaphp",level:3},{value:"Lando configuration file",id:"lando-configuration-file",level:3},{value:"phpcs.xml",id:"phpcsxml",level:3}];function d(e){const i={a:"a",code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",ul:"ul",...(0,l.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(i.p,{children:"A silta project requires two main configuration files, which give you the possibility to customize the behavior according to your requirements:"}),"\n",(0,t.jsxs)(i.ul,{children:["\n",(0,t.jsxs)(i.li,{children:["A ",(0,t.jsx)(i.a,{href:"#circleci-configuration",children:"CircleCI configuration file"}),". This defines how the application is built and tested."]}),"\n",(0,t.jsxs)(i.li,{children:["A ",(0,t.jsx)(i.a,{href:"#silta-configuration",children:"Silta configuration file"}),". This defines how the environment running your application is provisioned."]}),"\n"]}),"\n",(0,t.jsx)(i.h2,{id:"circleci-configuration",children:"CircleCI configuration"}),"\n",(0,t.jsxs)(i.p,{children:["This file is located in the project root at ",(0,t.jsx)(i.code,{children:".circleci/config.yml"})," and uses the official ",(0,t.jsx)(i.a,{href:"https://circleci.com/docs/2.0/configuration-reference/",children:"CircleCI"})," structure. Here is the default content:"]}),"\n",(0,t.jsx)(i.pre,{children:(0,t.jsx)(i.code,{className:"language-yaml",children:'version: 2.1\n\norbs:\n  silta: silta/silta@1\n\nworkflows:\n  version: 2\n  commit:\n    jobs:\n      - silta/drupal-validate:\n          name: validate\n          post-validation:\n            - run: echo "You can add additional validation here!"\n\n      - silta/drupal-build-deploy: &build-deploy\n          name: build-deploy\n          codebase-build:\n            - silta/drupal-composer-install\n            - silta/npm-install-build\n          context: global_nonprod\n          filters:\n            branches:\n              ignore: production\n\n      - silta/drupal-build-deploy:\n          # Extend the build-deploy configuration for the production environment.\n          <<: *build-deploy\n          name: build-deploy-prod\n          silta_config: silta/silta.yml,silta/silta-prod.yml\n          context: global_nonprod\n          filters:\n            branches:\n              only: production\n\n'})}),"\n",(0,t.jsx)(i.p,{children:"There are quite a few things going on, let's go through them one by one."}),"\n",(0,t.jsx)(i.pre,{children:(0,t.jsx)(i.code,{className:"language-yaml",children:"version: 2.1\n"})}),"\n",(0,t.jsx)(i.p,{children:"We use version 2.1 of the CircleCI API. If your project configured to use an older version, CircleCI will complain."}),"\n",(0,t.jsx)(i.pre,{children:(0,t.jsx)(i.code,{className:"language-yaml",children:"orbs:\n  silta: silta/silta@1\n"})}),"\n",(0,t.jsxs)(i.p,{children:["CircleCI has a packaging system called ",(0,t.jsx)(i.a,{href:"https://circleci.com/docs/2.0/orb-intro/#section=configuration",children:"orbs"}),".\nWe have published our own orb called ",(0,t.jsx)(i.code,{children:"silta/silta"}),", which enables you to use predefined jobs and commands."]}),"\n",(0,t.jsxs)(i.p,{children:["See available jobs in silta orb here: ",(0,t.jsx)(i.a,{href:"https://circleci.com/orbs/registry/orb/silta/silta",children:"https://circleci.com/orbs/registry/orb/silta/silta"})]}),"\n",(0,t.jsx)(i.pre,{children:(0,t.jsx)(i.code,{className:"language-yaml",children:"workflows:\n  version: 2\n  commit:\n    jobs:\n"})}),"\n",(0,t.jsx)(i.p,{children:"This is just the standard CircleCI declaration of what jobs are executed, and in what order."}),"\n",(0,t.jsx)(i.pre,{children:(0,t.jsx)(i.code,{className:"language-yaml",children:'- silta/drupal-validate:\n  name: validate\n  post-validation:\n    - run: echo "You can add additional validation here!"\n'})}),"\n",(0,t.jsxs)(i.p,{children:["The validation job checks your codebase for things that can be done without a running environment, like ",(0,t.jsx)(i.code,{children:"phpcs"}),".\nYou can adjust the phpcs configuration by editing phpcs.xml in your repository.\nYou can also add additional validation, like ",(0,t.jsx)(i.code,{children:"eslint"})," by adding custom steps in the\n",(0,t.jsx)(i.code,{children:"post-validation"})," section."]}),"\n",(0,t.jsx)(i.pre,{children:(0,t.jsx)(i.code,{className:"language-yaml",children:"- silta/drupal-build-deploy: &build-deploy\n  name: build-deploy\n  codebase-build:\n    - silta/drupal-composer-install\n    - silta/npm-install-build\n  context: global_nonprod\n  filters:\n    branches:\n      ignore: production\n"})}),"\n",(0,t.jsxs)(i.p,{children:["This is the main build and deployment job (we run them together to keep things simple and fast).\nThe ",(0,t.jsx)(i.code,{children:"&build-deploy"})," is a yaml reference so we can reuse this content later on."]}),"\n",(0,t.jsxs)(i.p,{children:[(0,t.jsx)(i.code,{children:"drupal-build-deploy"})," job is used for drupal chart deployments. There are more predefined jobs (i.e. ",(0,t.jsx)(i.code,{children:"silta/frontend-build-deploy"}),", ",(0,t.jsx)(i.code,{children:"silta/simple-build-deploy"}),") for other deployment jobs available in ",(0,t.jsx)(i.a,{href:"https://circleci.com/orbs/registry/orb/silta/silta",children:"silta orb"}),"."]}),"\n",(0,t.jsxs)(i.p,{children:["The ",(0,t.jsx)(i.code,{children:"codebase-build"})," parameter lets you specify how your project is built: by default we use two custom steps to\nget php dependencies with composer and frontend dependencies with npm."]}),"\n",(0,t.jsxs)(i.p,{children:["The ",(0,t.jsx)(i.code,{children:"context"})," parameter gives your project access to certain environment variables.\nIn our case, these contain the credentials to connect to a specific kubernetes cluster."]}),"\n",(0,t.jsxs)(i.p,{children:["The ",(0,t.jsx)(i.code,{children:"filters"})," section indicates that this job should not be run for the ",(0,t.jsx)(i.code,{children:"production"})," branch.\nThis branch has a dedicated job configuration as we will see below."]}),"\n",(0,t.jsx)(i.pre,{children:(0,t.jsx)(i.code,{className:"language-yaml",children:"- silta/drupal-build-deploy:\n  # Extend the build-deploy configuration for the production environment.\n  <<: *build-deploy\n  name: build-deploy-prod\n  silta_config: silta/silta.yml,silta/silta-prod.yml\n  context: global_nonprod\n  filters:\n    branches:\n      only: production\n"})}),"\n",(0,t.jsx)(i.p,{children:"This job reuses the previous job, it runs only for the production branch with the following differences:"}),"\n",(0,t.jsxs)(i.ul,{children:["\n",(0,t.jsx)(i.li,{children:"It has a different name."}),"\n",(0,t.jsx)(i.li,{children:"It uses one additional silta configuration configuration file which contains production-specific configuration."}),"\n",(0,t.jsx)(i.li,{children:"It can potentially deploy to a different cluster using different credentials."}),"\n"]}),"\n",(0,t.jsx)(i.h2,{id:"silta-configuration",children:"Silta-configuration"}),"\n",(0,t.jsxs)(i.p,{children:["The Silta configuration file is located in the Drupal root at ",(0,t.jsx)(i.code,{children:"silta/silta.yml"}),", it is an instance of a Helm values file.\nIt overrides the default values of our Helm chart (",(0,t.jsx)(i.a,{href:"https://github.com/wunderio/charts/blob/master/drupal/values.yaml",children:"https://github.com/wunderio/charts/blob/master/drupal/values.yaml"}),")\nand uses the same structure."]}),"\n",(0,t.jsxs)(i.p,{children:["Here is a list of ",(0,t.jsx)(i.a,{href:"/silta/docs/silta-examples",children:"sample configuration changes"})," for common requirements."]}),"\n",(0,t.jsx)(i.h2,{id:"additional-files",children:"Additional files"}),"\n",(0,t.jsx)(i.p,{children:"There are a few additional files that often won't need to be modified but which play an important role."}),"\n",(0,t.jsx)(i.h3,{id:"dockerfiles",children:"Dockerfiles"}),"\n",(0,t.jsxs)(i.p,{children:["The ",(0,t.jsx)(i.code,{children:"silta"})," folder contains three Dockerfiles for nginx, php and the shell container.\nAll of them are built simply by copying the codebase into the base docker image."]}),"\n",(0,t.jsx)(i.p,{children:"It would be possible to make modifications to the containers by modifying these Dockerfiles, or even to use different base images.\nHowever, while this is very powerful it is quite likely that there is a better way to fulfill your needs using configuration."}),"\n",(0,t.jsx)(i.h3,{id:"dockerignore",children:".dockerignore"}),"\n",(0,t.jsxs)(i.p,{children:["There are two ",(0,t.jsx)(i.code,{children:".dockerignore"})," files, one in the Drupal root (for the php and shell containers), and one in the web root (for nginx).\nThese specify which files should be ignored when creating project-specific Docker images, improving build time, image size and security."]}),"\n",(0,t.jsx)(i.h3,{id:"silta-production-configuration",children:"Silta production configuration"}),"\n",(0,t.jsxs)(i.p,{children:["This file is located in ",(0,t.jsx)(i.code,{children:"silta/silta.prod.yml"})," and provides an additional level of override specifically for the production envrionment."]}),"\n",(0,t.jsx)(i.h3,{id:"settingssiltaphp",children:"settings.silta.php"}),"\n",(0,t.jsx)(i.p,{children:"This file is actually not part of the repository, but gets mounted into the running container (replacing any existing file with that name).\nIt loads the database credential and additional Silta-specific configuration. You don't need to modify it (you can't), but you need to make sure\nthat it gets included from your settings.php."}),"\n",(0,t.jsx)(i.h3,{id:"lando-configuration-file",children:"Lando configuration file"}),"\n",(0,t.jsx)(i.p,{children:"This file is not actually needed to deploy a project to Silta, but it configures the project for\nusage in local developemnt environments with Lando. Silta doesn't specify how you should run your code locally, but Lando and Silta have compatible of working."}),"\n",(0,t.jsx)(i.p,{children:"There is no plan to consolidate Silta and Lando, as they have very different requirements (for example Lando mounts the codebase as a volume, whereas Silta copies it into dedicated Docker images)."}),"\n",(0,t.jsx)(i.h3,{id:"phpcsxml",children:"phpcs.xml"}),"\n",(0,t.jsx)(i.p,{children:"This file is also not required for Silta, but we use phpcs for validation by default."})]})}function h(e={}){const{wrapper:i}={...(0,l.R)(),...e.components};return i?(0,t.jsx)(i,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}}}]);