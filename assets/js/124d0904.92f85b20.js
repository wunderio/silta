"use strict";(self.webpackChunksilta_docs=self.webpackChunksilta_docs||[]).push([[451],{8338:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>c,contentTitle:()=>a,default:()=>u,frontMatter:()=>l,metadata:()=>r,toc:()=>o});const r=JSON.parse('{"id":"vendor-eks","title":"Amazon Web Services compatibility","description":"Silta is mostly AWS compatible, there are some requirements for environments deployed to EKS cluster.","source":"@site/docs/vendor-eks.md","sourceDirName":".","slug":"/vendor-eks","permalink":"/silta/docs/vendor-eks","draft":false,"unlisted":false,"editUrl":"https://github.com/wunderio/silta/tree/master/docs/vendor-eks.md","tags":[],"version":"current","frontMatter":{}}');var t=s(4848),i=s(8453);const l={},a="Amazon Web Services compatibility",c={},o=[{value:"Cluster requirements",id:"cluster-requirements",level:2},{value:"Preparation steps",id:"preparation-steps",level:3},{value:"S3 backend for csi-rclone",id:"s3-backend-for-csi-rclone",level:4},{value:"Silta-cluster chart requirements",id:"silta-cluster-chart-requirements",level:3},{value:"Missing functionality",id:"missing-functionality",level:2},{value:"Deployment specifics",id:"deployment-specifics",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,i.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"amazon-web-services-compatibility",children:"Amazon Web Services compatibility"})}),"\n",(0,t.jsx)(n.p,{children:"Silta is mostly AWS compatible, there are some requirements for environments deployed to EKS cluster."}),"\n",(0,t.jsx)(n.h2,{id:"cluster-requirements",children:"Cluster requirements"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Ingress-nginx as the Ingress choice"}),"\n",(0,t.jsx)(n.li,{children:"Amazon VPC CNI plugin for NetworkPolicy"}),"\n",(0,t.jsx)(n.li,{children:"Amazon EBS CSI Driver plugin for default storage class (gp2)"}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"preparation-steps",children:"Preparation steps"}),"\n",(0,t.jsx)(n.p,{children:"On new, empty cluster, before installing silta-cluster chart:"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:"Install Amazon VPC CNI plugin (plugins are located in EKS -> cluster > Add-ons tab)"}),"\n",(0,t.jsx)(n.li,{children:"Install Amazon EBC CSI Driver plugin"}),"\n",(0,t.jsxs)(n.li,{children:["Create and attach IAM role to worker nodes with these permissions:","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"AmazonEC2ContainerRegistryFullAccess"}),"\n",(0,t.jsx)(n.li,{children:"AmazonEC2FullAccess"}),"\n",(0,t.jsx)(n.li,{children:"AmazonEKSWorkerNodePolicy"}),"\n",(0,t.jsx)(n.li,{children:"AmazonElasticFileSystemFullAccess"}),"\n",(0,t.jsx)(n.li,{children:"AmazonS3FullAccess"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.h4,{id:"s3-backend-for-csi-rclone",children:"S3 backend for csi-rclone"}),"\n",(0,t.jsx)(n.p,{children:"Create a custom policy, storage user, attach policy to storage user and acquire keys for it."}),"\n",(0,t.jsx)(n.p,{children:"Custom policy:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:'{\n  "Version": "2012-10-17",\n  "Statement": [\n    {\n      "Effect": "Allow",\n      "Action": [\n        "s3:ListBucket",\n        "s3:DeleteObject",\n        "s3:GetObject",\n        "s3:PutObject",\n        "s3:PutObjectAcl"\n      ],\n      "Resource": [\n        "arn:aws:s3:::BUCKET_NAME/*",\n        "arn:aws:s3:::BUCKET_NAME"\n      ]\n    },\n    {\n      "Effect": "Allow",\n      "Action": "s3:ListAllMyBuckets",\n      "Resource": "arn:aws:s3:::*"\n    }\n  ]\n}\n'})}),"\n",(0,t.jsx)(n.p,{children:"csi-clone configuration:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:'csi-rclone:\n  enabled: true\n  params:\n    remote: s3\n    remotePath: <bucket-name>\n    s3-provider: AWS\n    s3-endpoint: ""\n    s3-region: <region>\n    s3-access-key-id: <KEY-ID>\n    s3-secret-access-key: <ACCESS-KEY>\n    s3-acl: private\n'})}),"\n",(0,t.jsxs)(n.p,{children:["Note: ",(0,t.jsx)(n.code,{children:"s3-endpoint"})," needs override due to minio endpoint in chart defaults."]}),"\n",(0,t.jsx)(n.h3,{id:"silta-cluster-chart-requirements",children:"Silta-cluster chart requirements"}),"\n",(0,t.jsx)(n.p,{children:"Enabling proxy protocol over ingress-nginx, for passing client IP to pods:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:'  ingress-nginx:\n    controller:\n      config:\n        use-proxy-protocol: true\n    service:\n      annotations:\n        "service.beta.kubernetes.io/aws-load-balancer-proxy-protocol": "*"\n'})}),"\n",(0,t.jsx)(n.p,{children:"SSH uses NLB as ingress point. Apply these annotations:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:'gitAuth:\n  enabled: true\n  scope: \'https://github.com/wunderio\'\n  annotations:\n    "service.beta.kubernetes.io/aws-load-balancer-backend-protocol": "tcp"\n    "service.beta.kubernetes.io/aws-load-balancer-connection-idle-timeout": "60"\n    # "service.beta.kubernetes.io/aws-load-balancer-cross-zone-load-balancing-enabled": "true"\n    "service.beta.kubernetes.io/aws-load-balancer-type": "nlb"\n    # the length of the list must be equal to the number of subnets\n    "service.beta.kubernetes.io/aws-load-balancer-eip-allocations": "<elastic IP id>"\n    "service.beta.kubernetes.io/aws-load-balancer-subnets": "<subnet name here>,<subnet name here>,..."\n    "service.beta.kubernetes.io/aws-load-balancer-nlb-target-type": "instance"\n    "service.beta.kubernetes.io/aws-load-balancer-ip-address-type": "ipv4"\n    "service.beta.kubernetes.io/aws-load-balancer-target-group-attributes": "stickiness.enabled=true,stickiness.type=source_ip,preserve_client_ip.enabled=true"\n'})}),"\n",(0,t.jsx)(n.p,{children:"For NLB, it is required to have 1 Elastic IP per subnet (defined by Availability Zones)"}),"\n",(0,t.jsx)(n.p,{children:"EIP Allocation ID is in Network & Security -> Elastic IPs"}),"\n",(0,t.jsx)(n.p,{children:"Subnet names are in VPC Dashboard -> Virtual Private Cloud -> Subnets"}),"\n",(0,t.jsxs)(n.p,{children:["There are few more requirements listed on ",(0,t.jsx)(n.a,{href:"https://github.com/wunderio/charts/tree/master/silta-cluster#requirements",children:"silta-cluster chart page"}),", those are common for all silta-cluster installations"]}),"\n",(0,t.jsx)(n.h2,{id:"missing-functionality",children:"Missing functionality"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"NLB for HTTP/HTTPS ingress"}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"deployment-specifics",children:"Deployment specifics"}),"\n",(0,t.jsxs)(n.p,{children:["There is no extra configuration required for basic deployments. The only change would be ",(0,t.jsx)(n.code,{children:"cluster.type"})," but it's normally overridden in CI pipeline."]}),"\n",(0,t.jsx)(n.p,{children:"Drupal, frontend and simple charts:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"cluster:\n  type: aws\n"})})]})}function u(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},8453:(e,n,s)=>{s.d(n,{R:()=>l,x:()=>a});var r=s(6540);const t={},i=r.createContext(t);function l(e){const n=r.useContext(i);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:l(e.components),r.createElement(i.Provider,{value:n},e.children)}}}]);