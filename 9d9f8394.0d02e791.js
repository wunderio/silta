(window.webpackJsonp=window.webpackJsonp||[]).push([[13],{100:function(e,t,n){"use strict";n.d(t,"a",(function(){return p})),n.d(t,"b",(function(){return m}));var a=n(0),o=n.n(a);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,o=function(e,t){if(null==e)return{};var n,a,o={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var c=o.a.createContext({}),b=function(e){var t=o.a.useContext(c),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},p=function(e){var t=b(e.components);return o.a.createElement(c.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return o.a.createElement(o.a.Fragment,{},t)}},d=o.a.forwardRef((function(e,t){var n=e.components,a=e.mdxType,i=e.originalType,r=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),p=b(n),d=a,m=p["".concat(r,".").concat(d)]||p[d]||u[d]||i;return n?o.a.createElement(m,s(s({ref:t},c),{},{components:n})):o.a.createElement(m,s({ref:t},c))}));function m(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var i=n.length,r=new Array(i);r[0]=d;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:a,r[1]=s;for(var c=2;c<i;c++)r[c]=n[c];return o.a.createElement.apply(null,r)}return o.a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},82:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return r})),n.d(t,"metadata",(function(){return s})),n.d(t,"toc",(function(){return l})),n.d(t,"default",(function(){return b}));var a=n(3),o=n(7),i=(n(0),n(100)),r={id:"troubleshooting",title:"Troubleshooting and FAQ",sidebar_label:"Troubleshooting"},s={unversionedId:"troubleshooting",id:"troubleshooting",isDocsHomePage:!1,title:"Troubleshooting and FAQ",description:"Deployment issues",source:"@site/docs/troubleshooting.md",slug:"/troubleshooting",permalink:"/silta/docs/troubleshooting",editUrl:"https://github.com/wunderio/silta/tree/master/docs/troubleshooting.md",version:"current",sidebar_label:"Troubleshooting",sidebar:"someSidebar",previous:{title:"Silta examples",permalink:"/silta/docs/silta-examples"}},l=[{value:"Q: Helm release fails due to existing resources",id:"q-helm-release-fails-due-to-existing-resources",children:[]},{value:"Q: Helm deployment fails with retry404 option",id:"q-helm-deployment-fails-with-retry404-option",children:[]},{value:"Q: How to connect to silta ssh?",id:"q-how-to-connect-to-silta-ssh",children:[]},{value:"Q: There is no connection information in deployment\u2019s release notes!",id:"q-there-is-no-connection-information-in-deployments-release-notes",children:[]},{value:"Q: How to enable ssh access to project?",id:"q-how-to-enable-ssh-access-to-project",children:[]},{value:"Q: &quot;Error: Connection refused&quot; when connecting via SSH",id:"q-error-connection-refused-when-connecting-via-ssh",children:[]},{value:"Q: Timeout without error when connecting via SSH",id:"q-timeout-without-error-when-connecting-via-ssh",children:[]},{value:"Q: SSH connection asks for password or refuses connection",id:"q-ssh-connection-asks-for-password-or-refuses-connection",children:[]},{value:"Q: SSH connection public key authentication failure",id:"q-ssh-connection-public-key-authentication-failure",children:[]},{value:"Q: Silta website asks for password, what\u2019s the password?",id:"q-silta-website-asks-for-password-whats-the-password",children:[]},{value:"Q: How do i change/disable site password?",id:"q-how-do-i-changedisable-site-password",children:[]},{value:"Q: How to allow access only based on IP?",id:"q-how-to-allow-access-only-based-on-ip",children:[]},{value:"Mariadb or Elasticsearch running out of disk space",id:"mariadb-or-elasticsearch-running-out-of-disk-space",children:[]},{value:"Q: How to enable persistent storage for private files in drupal chart?",id:"q-how-to-enable-persistent-storage-for-private-files-in-drupal-chart",children:[]},{value:"Q: How do I enable backups?",id:"q-how-do-i-enable-backups",children:[]},{value:"Q: How do i know backups work?",id:"q-how-do-i-know-backups-work",children:[]},{value:"Q: How do i send e-mails?",id:"q-how-do-i-send-e-mails",children:[]},{value:"Q: How do i create redirects?",id:"q-how-do-i-create-redirects",children:[]},{value:"Q: What is the Elasticsearch host address?",id:"q-what-is-the-elasticsearch-host-address",children:[]},{value:"Q: Custom certificate is not found",id:"q-custom-certificate-is-not-found",children:[]},{value:"Q: Site keeps complaining about SSL certificate",id:"q-site-keeps-complaining-about-ssl-certificate",children:[]},{value:"Q: Deployment fails due to misconfigured memory assignments",id:"q-deployment-fails-due-to-misconfigured-memory-assignments",children:[]},{value:"Q: PHP FPM containers print &quot;read-only file system&quot; error on startup",id:"q-php-fpm-containers-print-read-only-file-system-error-on-startup",children:[]},{value:"Q: How to encrypt sensitive information?",id:"q-how-to-encrypt-sensitive-information",children:[]},{value:"Q: How to change the webroot for drupal chart?",id:"q-how-to-change-the-webroot-for-drupal-chart",children:[]},{value:"How to customize container images of Silta deployments?",id:"how-to-customize-container-images-of-silta-deployments",children:[]},{value:"Q: How to test docker images?",id:"q-how-to-test-docker-images",children:[]},{value:"Q: How to run Silta images locally?",id:"q-how-to-run-silta-images-locally",children:[]}],c={toc:l};function b(e){var t=e.components,n=Object(o.a)(e,["components"]);return Object(i.b)("wrapper",Object(a.a)({},c,n,{components:t,mdxType:"MDXLayout"}),Object(i.b)("h1",{id:"deployment-issues"},"Deployment issues"),Object(i.b)("h2",{id:"q-helm-release-fails-due-to-existing-resources"},"Q: Helm release fails due to existing resources"),Object(i.b)("p",null,"Error:"),Object(i.b)("blockquote",null,Object(i.b)("p",{parentName:"blockquote"},'kind PersistentVolume with the name "project-123--branchname-someresource" already exists in the cluster and wasn\'t defined in the previous release.')),Object(i.b)("p",null,"A: This error happens when a release that created a new resource failed.\nThe resource that is now in the way needs to be deleted, please ask someone with direct access to the cluster to do that."),Object(i.b)("h2",{id:"q-helm-deployment-fails-with-retry404-option"},"Q: Helm deployment fails with retry404 option"),Object(i.b)("p",null,"Error:"),Object(i.b)("blockquote",null,Object(i.b)("p",{parentName:"blockquote"},"[emerg]",' 1#1: unknown directive "echo_sleep" in /etc/nginx/conf.d/drupal.conf:292\nnginx: ',"[emerg]",' unknown directive "echo_sleep" in /etc/nginx/conf.d/drupal.conf:292')),Object(i.b)("p",null,"A: Ensure you are using an nginx version with this ",Object(i.b)("inlineCode",{parentName:"p"},"echo")," module compiled in.\nIn silta/nginx.Dockerfile, the FROM instructive should point to one of the newer versions, for example, latest available."),Object(i.b)("p",null,"Versions available are listed here: ",Object(i.b)("a",{parentName:"p",href:"https://github.com/wunderio/silta-images/tree/master/nginx"},"https://github.com/wunderio/silta-images/tree/master/nginx")),Object(i.b)("p",null,"Note: nginx:v0.1, wunderio/drupal Docker images do not have this module."),Object(i.b)("p",null,"Example: ",Object(i.b)("inlineCode",{parentName:"p"},"FROM wunderio/silta-nginx:latest")),Object(i.b)("h1",{id:"issues-with-the-deployed-environments"},"Issues with the deployed environments"),Object(i.b)("h2",{id:"q-how-to-connect-to-silta-ssh"},"Q: How to connect to silta ssh?"),Object(i.b)("p",null,"A: SSH connection information is available in your circleci release notes."),Object(i.b)("h2",{id:"q-there-is-no-connection-information-in-deployments-release-notes"},"Q: There is no connection information in deployment\u2019s release notes!"),Object(i.b)("p",null,"A: SSH access is not enabled most likely."),Object(i.b)("h2",{id:"q-how-to-enable-ssh-access-to-project"},"Q: How to enable ssh access to project?"),Object(i.b)("p",null,"A: See default values for the helm chart you are using for deployment."),Object(i.b)("h2",{id:"q-error-connection-refused-when-connecting-via-ssh"},'Q: "Error: Connection refused" when connecting via SSH'),Object(i.b)("p",null,"Error:"),Object(i.b)("blockquote",null,Object(i.b)("p",{parentName:"blockquote"},"channel 0: open failed: connect failed: Connection refused\nstdio forwarding failed\nssh_exchange_identification: Connection closed by remote host")),Object(i.b)("p",null,"Possible causes:"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},Object(i.b)("p",{parentName:"li"},"The ",Object(i.b)("inlineCode",{parentName:"p"},"shell")," pod is not done deploying. Wait for ten seconds and try again.")),Object(i.b)("li",{parentName:"ul"},Object(i.b)("p",{parentName:"li"},"There is no ",Object(i.b)("inlineCode",{parentName:"p"},"shell")," access in frontend chart by default, You need to enable it (",Object(i.b)("inlineCode",{parentName:"p"},"shell.enabled: true"),") and use customized base images from ",Object(i.b)("a",{parentName:"p",href:"https://hub.docker.com/r/wunderio/silta-node"},"https://hub.docker.com/r/wunderio/silta-node")," "))),Object(i.b)("h2",{id:"q-timeout-without-error-when-connecting-via-ssh"},"Q: Timeout without error when connecting via SSH"),Object(i.b)("p",null,"Error:"),Object(i.b)("blockquote",null,Object(i.b)("p",{parentName:"blockquote"},"ssh: connect to host ssh.","[cluster.domain]"," port 22: Operation timed out\nssh_exchange_identification: Connection closed by remote host")),Object(i.b)("p",null,"Possible causes: "),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},"SSH access is IP restricted, You are probably not logged into the VPN."),Object(i.b)("li",{parentName:"ul"},"SSH server just got restarted, wait couple minutes and try again")),Object(i.b)("h2",{id:"q-ssh-connection-asks-for-password-or-refuses-connection"},"Q: SSH connection asks for password or refuses connection"),Object(i.b)("p",null,"Error message:"),Object(i.b)("blockquote",null,Object(i.b)("p",{parentName:"blockquote"},"ssh ",Object(i.b)("a",{parentName:"p",href:"mailto:www-admin@master-shell.projectname"},"www-admin@master-shell.projectname")," -J www-admin@ssh.","[cluster.domain]","\n",Object(i.b)("a",{parentName:"p",href:"mailto:www-admin@master-shell.projecname"},"www-admin@master-shell.projecname"),"'s password:")),Object(i.b)("p",null,"Error message 2:"),Object(i.b)("blockquote",null,Object(i.b)("p",{parentName:"blockquote"},"channel 0: open failed: connect failed: Connection refused\nstdio forwarding failed\nkex_exchange_identification: Connection closed by remote host")),Object(i.b)("p",null,"Error message 3:"),Object(i.b)("blockquote",null,Object(i.b)("p",{parentName:"blockquote"},"channel 0: open failed: connect failed: Name does not resolve\nstdio forwarding failed\nkex_exchange_identification: Connection closed by remote host")),Object(i.b)("p",null,"Possible causes:"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},Object(i.b)("p",{parentName:"li"},"Shell container might be in unready state. Check pod via kubectl or silta dashboard (internal tool). And ensure all pods are running. If not, wait.")),Object(i.b)("li",{parentName:"ul"},Object(i.b)("p",{parentName:"li"},"It\u2019s possible your public key is not added to your github profile, make sure it is;")),Object(i.b)("li",{parentName:"ul"},Object(i.b)("p",{parentName:"li"},"You are not project contributor in github, make sure you can push commits to repo;")),Object(i.b)("li",{parentName:"ul"},Object(i.b)("p",{parentName:"li"},"Remove all occurrences of hostname (i.e. master-shell.projectname) from ~/.ssh/known_hosts")),Object(i.b)("li",{parentName:"ul"},Object(i.b)("p",{parentName:"li"},"If you have changed the ",Object(i.b)("inlineCode",{parentName:"p"},"clusterDomain")," value in your silta configuration file, you need to set ",Object(i.b)("inlineCode",{parentName:"p"},"shell.gitAuth.keyserver.url")," to ",Object(i.b)("inlineCode",{parentName:"p"},"https://keys.[cluster.domain]/api/1/git-ssh-keys"),". Otherwise ",Object(i.b)("a",{parentName:"p",href:"https://github.com/wunderio/silta-images/blob/master/shell/php-8.0/gitauth_keys.sh#L6"},"curl in public key download script")," complains about broken certificate and the authentication does not work.")),Object(i.b)("li",{parentName:"ul"},Object(i.b)("p",{parentName:"li"},"The ssh jumphost domain may be incorrect. Normally You'd get a full connection url in release notes, but if part of the domain is masked (*",Object(i.b)("strong",{parentName:"p"},"*), don't assume it to be silta.wdr.io. Actual domain replacement depends on the context (check TLDR answer for \"Secret masking and ",Object(i.b)("strong",{parentName:"strong"},Object(i.b)("strong",{parentName:"strong"},"**"))),'" topic).'))),Object(i.b)("p",null,"If all above fails ask OPS team to check ssh-keyserver."),Object(i.b)("h2",{id:"q-ssh-connection-public-key-authentication-failure"},"Q: SSH connection public key authentication failure"),Object(i.b)("p",null,"Error:"),Object(i.b)("blockquote",null,Object(i.b)("p",{parentName:"blockquote"},Object(i.b)("a",{parentName:"p",href:"mailto:username@X.X.X.X"},"username@X.X.X.X"),": Permission denied (publickey).")),Object(i.b)("p",null,"A: Authentication is based on your GitHub key, but there is trouble reading it. Use the key explicitly using ",Object(i.b)("inlineCode",{parentName:"p"},"-i [path_to_identity_file]")," option:"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-bash"},"ssh X.X.X.X -i ~/.ssh/keys/wunder-github.rsa \n")),Object(i.b)("h2",{id:"q-silta-website-asks-for-password-whats-the-password"},"Q: Silta website asks for password, what\u2019s the password?"),Object(i.b)("p",null,"A: Password is printed in circleci build release notes."),Object(i.b)("h2",{id:"q-how-do-i-changedisable-site-password"},"Q: How do i change/disable site password?"),Object(i.b)("p",null,"A: Check chart default values file, nginx.basicauth section. Check ",Object(i.b)("a",{parentName:"p",href:"/silta/docs/silta-examples"},"silta \u200bexamples")," for example snippet. Make changes in silta.yml or silta-prod.yml accordingly. You can also whitelist ip addresses to skip password request (do this with caution). Check nginx.noauthips in chart defaults."),Object(i.b)("h2",{id:"q-how-to-allow-access-only-based-on-ip"},"Q: How to allow access only based on IP?"),Object(i.b)("p",null,"A: There is no built-in solution for silta, but You can add custom nginx configuration snippet to achieve it."),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-yaml"},"nginx:\n  locationExtraConfig: |\n    allow 1.2.3.4/32;\n    deny all;\n")),Object(i.b)("h2",{id:"mariadb-or-elasticsearch-running-out-of-disk-space"},"Mariadb or Elasticsearch running out of disk space"),Object(i.b)("p",null,"Error:"),Object(i.b)("blockquote",null,Object(i.b)("p",{parentName:"blockquote"},"The table \u2018XYZ\u2019 is full")),Object(i.b)("p",null,"Stateful applications like MariaDB or Elasticsearch store their data in persistent data volumes. It is possible to resize (expand) those disks (only increasing storage is supported), but this is not yet integrated with the process of updating a statefulset.\nYou can change the requested size by setting the ",Object(i.b)("inlineCode",{parentName:"p"},"elasticsearch.volumeClaimTemplate.resources.requests.storage")," or ",Object(i.b)("inlineCode",{parentName:"p"},"mariadb.master.persistence.size")," field in the ",Object(i.b)("inlineCode",{parentName:"p"},"silta.yml")," for the appropriate service (",Object(i.b)("inlineCode",{parentName:"p"},"mariadb")," or ",Object(i.b)("inlineCode",{parentName:"p"},"elasticsearch"),"), but You also need ops interaction to patch the statefulset:"),Object(i.b)("p",null,"MariaDB storage request (re-check correct values with mariadb subchart if needed):"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-yaml"},"mariadb:\n  master:\n    persistence:\n      # Database storage disk space allocation\n      # Request assistance from ops team after changing this on existing deployment.\n      size: 5Gi\n")),Object(i.b)("p",null,"Elasticsearch storage request (re-check correct values with elasticsearch subchart if needed):"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-yaml"},"elasticsearch:\n  volumeClaimTemplate:\n    resources:\n      requests:\n        # Elasticsearch storage disk space allocation\n        # Request assistance from ops team after changing this on existing deployment.\n        storage: 5Gi\n")),Object(i.b)("p",null,"If the size is less than 5Gi, set it to 5Gi. If it's 5Gi or more, double the previous value."),Object(i.b)("p",null,"Due to inability to patch immutable fields in mariadb statefulset, the next build will fail unless cluster administrator runs these commands manually:"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-bash"},'namespace="name-of-repository"\npvc="data-master-mariadb-0" # Find this with kubectl get pvc -n $namespace\nstatefulset="master-mariadb"\n\nkubectl patch pvc -n $namespace $pvc -p \'{"spec": {"resources": {"requests": {"storage": "5Gi"}}}}\'\nkubectl delete statefulset  -n $namespace --cascade=orphan $statefulset\n')),Object(i.b)("p",null,"NOTE: If updating pvc size you are met with error:"),Object(i.b)("blockquote",null,Object(i.b)("p",{parentName:"blockquote"},'error: persistentvolumeclaims "xxx-xxx" could not be patched: persistentvolumeclaims "xxx-xxx" is forbidden: only dynamically provisioned pvc can be resized and the storageclass that provisions the pvc must support resize')),Object(i.b)("p",null,'Check that Kubernetes is running at least v1.16 and then edit the corresponding storageclass, "standard" (google kubernetes engine only) in this case:'),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-bash"},"kubectl patch storageclass standard -p '{\"allowVolumeExpansion\": true}'\n")),Object(i.b)("h2",{id:"q-how-to-enable-persistent-storage-for-private-files-in-drupal-chart"},"Q: How to enable persistent storage for private files in drupal chart?"),Object(i.b)("p",null,"Sometimes you'd also get error like this:"),Object(i.b)("blockquote",null,Object(i.b)("p",{parentName:"blockquote"},"(changing permissions of 'private/': Operation not permitted)")),Object(i.b)("p",null,"A: There are good defaults for private files persistent storage already, You just have to enable it in silta.yml file. Check the mount defaults in chart defaults too."),Object(i.b)("p",null,"Drupal chart:"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-yaml"},"mounts:\n  private-files:\n    enabled: true\n")),Object(i.b)("h2",{id:"q-how-do-i-enable-backups"},"Q: How do I enable backups?"),Object(i.b)("p",null,'A: Drupal chart: search "backup" in chart values file for the answer.'),Object(i.b)("p",null,"A: Frontend chart: Backups can be enabled via ",Object(i.b)("inlineCode",{parentName:"p"},"backups.enabled: true")," and it will back up mounts defined at ",Object(i.b)("inlineCode",{parentName:"p"},".Values.mounts"),". There's also an option to run custom commands during backup using ",Object(i.b)("inlineCode",{parentName:"p"},"services.yourservice.backup.command")," (see services section in chart values.yml). Keep in mind that once the container stops, the data that is not stored on a persistent storage (backed up) will disappear."),Object(i.b)("h2",{id:"q-how-do-i-know-backups-work"},"Q: How do i know backups work?"),Object(i.b)("p",null,"A: Backup process is done in a dedicated pod with a specific instructions to make a backup. Check backup pod output in silta dashboard (i.e. ",Object(i.b)("inlineCode",{parentName:"p"},"production-backup-1590113220-n4m7p"),"). If the pod state is ",Object(i.b)("inlineCode",{parentName:"p"},"Succeeded"),", it's good. Check the logs too, you can see the backup content and size. The pod state is kept till the next backup is started."),Object(i.b)("h2",{id:"q-how-do-i-send-e-mails"},"Q: How do i send e-mails?"),Object(i.b)("p",null,'A: Check silta documentation, "',Object(i.b)("a",{parentName:"p",href:"/silta/docs/silta-examples#sending-e-mail"},"Sending e-mail"),'" section'),Object(i.b)("h2",{id:"q-how-do-i-create-redirects"},"Q: How do i create redirects?"),Object(i.b)("p",null,'A: Check silta documentation, "',Object(i.b)("a",{parentName:"p",href:"/silta/docs/silta-examples#add-redirects"},"Adding redirects"),'" section'),Object(i.b)("h2",{id:"q-what-is-the-elasticsearch-host-address"},"Q: What is the Elasticsearch host address?"),Object(i.b)("p",null,"A: Elasticsearch host address is available via ",Object(i.b)("inlineCode",{parentName:"p"},"ELASTICSEARCH_HOST")," environment variable."),Object(i.b)("h2",{id:"q-custom-certificate-is-not-found"},"Q: Custom certificate is not found"),Object(i.b)("p",null,"Error:"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre"},'ERROR: Error: template: drupal/templates/drupal-certificate.yaml:88:31: executing "drupal/templates/drupal-certificate.yaml" at <b64enc>: invalid value; expected string\n')),Object(i.b)("p",null,"A: It's possible that You have either:"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},"not defined ",Object(i.b)("inlineCode",{parentName:"li"},".Values.ssl")," (or ",Object(i.b)("inlineCode",{parentName:"li"},".Values.exposeDomainsDefaults")," or ",Object(i.b)("inlineCode",{parentName:"li"},".Values.exposeDomains.ssl"),"); or"),Object(i.b)("li",{parentName:"ul"},"have forgotten to provide this configuration file containing secrets to deployment (i.e. ",Object(i.b)("inlineCode",{parentName:"li"},"silta_config")," in for CircleCI Silta orb's ",Object(i.b)("inlineCode",{parentName:"li"},"silta/drupal-build-deploy")," job or ",Object(i.b)("inlineCode",{parentName:"li"},"--silta-config")," for ",Object(i.b)("inlineCode",{parentName:"li"},"silta ci release deploy")," cli command). ")),Object(i.b)("h2",{id:"q-site-keeps-complaining-about-ssl-certificate"},"Q: Site keeps complaining about SSL certificate"),Object(i.b)("p",null,"Error:"),Object(i.b)("blockquote",null,Object(i.b)("p",{parentName:"blockquote"},"Warning: Potential Security Risk Ahead")),Object(i.b)("p",null,"A: The SSL certificate is broken/incorrect. There are multiple types of certificates:"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},Object(i.b)("p",{parentName:"li"},'Custom certificates. Most frequent issue is that the CA certificate is not added to the bundle. Add it both to "tls.ca" and "tls.crt" fields. The order of certificates is server.crt -> intermediate.crt -> root.crt.')),Object(i.b)("li",{parentName:"ul"},Object(i.b)("p",{parentName:"li"},'Letsencrypt-staging. Unless You don\'t need it specifically, change it to "letsencrypt".')),Object(i.b)("li",{parentName:"ul"},Object(i.b)("p",{parentName:"li"},"Letsencrypt. One of possible causes, is, You added the exposeDomain long before DNS was actually changed and certificate issuer has timed out. Try to deploy the exposeDomains as close to DNS change as possible next time! Ask ops support to remove cert-manager challenge resource, so it recreates validation pod and it triggers repeated validation."))),Object(i.b)("h2",{id:"q-deployment-fails-due-to-misconfigured-memory-assignments"},"Q: Deployment fails due to misconfigured memory assignments"),Object(i.b)("p",null,"Error log example #1:"),Object(i.b)("blockquote",null,Object(i.b)("p",{parentName:"blockquote"},"Warning  Failed                  45s (x4 over 101s)  kubelet, ","[node-id]",'  Error: failed to create containerd task: OCI runtime create failed: container_linux.go: 349: starting container process caused "process_linux.go:449: container init caused \\"process_linux.go:415: setting cgroup config for procHooks process caused ',"\\",'\\"failed to write ',"\\","\\","\\",'\\"5',"\\","\\","\\",'\\" to ',"\\","\\","\\",'\\"/sys/fs/cgroup/memory/kubepods/burstable/',"[pod-id]","/php/memory.limit_in_bytes","\\","\\","\\",'\\": write /sys/fs/cgroup/memory/kubepods/burstable/',"[pod-id]","/php/memory.limit_in_bytes: device or resource busy","\\",'\\"\\"": unknown   ')),Object(i.b)("p",null,"Event log example #2"),Object(i.b)("blockquote",null,Object(i.b)("p",{parentName:"blockquote"},'Failed to create pod sandbox: rpc error: code = Unknown desc = failed to create containerd task: OCI runtime create failed: container_linux.go:349: starting container process caused "process_linux.go:319: getting the final child\'s pid from pipe caused \\"EOF\\"": unknown')),Object(i.b)("p",null,'A: This happens due to misconfigured memory limits or requests. Most plausible cause, memory unit is "m" while it should be "M".\nNote: cpu resources, however, are defined with lower case "m" (millicpu). More on kubernetes resource management (and "M" vs "Mi") here: ',Object(i.b)("a",{parentName:"p",href:"https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/"},"https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/")),Object(i.b)("h2",{id:"q-php-fpm-containers-print-read-only-file-system-error-on-startup"},'Q: PHP FPM containers print "read-only file system" error on startup'),Object(i.b)("p",null,"Error:"),Object(i.b)("blockquote",null,Object(i.b)("p",{parentName:"blockquote"},"2021/08/20 06:22:38 ","[ ERROR ]"," Error while parsing '/usr/local/etc/php-fpm.d/zz-custom.conf': open /usr/local/etc/php-fpm.d/zz-custom.conf: read-only file system")),Object(i.b)("p",null,"TLDR A: Can't make it go away."),Object(i.b)("p",null,"A: There are customizations we need to inject into containers, but the way kubernetes works, is it only allows to map those template configuration files as read only which php does not like (complains about).There are couple ideas (hacks) in some issue queues that we tried and did not succeed, but there are few others that we might try again one day. Until then - there's that message. Related issue: ",Object(i.b)("a",{parentName:"p",href:"https://github.com/kubernetes/kubernetes/issues/62099"},"https://github.com/kubernetes/kubernetes/issues/62099")),Object(i.b)("h2",{id:"q-how-to-encrypt-sensitive-information"},"Q: How to encrypt sensitive information?"),Object(i.b)("p",null,'A: Use openssl as described in silta docs in "',Object(i.b)("a",{parentName:"p",href:"/silta/docs/encrypting-sensitive-configuration"},"Encrypting sensitive configuration"),'"'),Object(i.b)("h2",{id:"q-how-to-change-the-webroot-for-drupal-chart"},"Q: How to change the webroot for drupal chart?"),Object(i.b)("p",null,"By default, the webroot is configured to be in ",Object(i.b)("inlineCode",{parentName:"p"},"/app/web"),". This value can be changed in the Drupal chart, see example below."),Object(i.b)("p",null,"Drupal chart:"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-yaml"},"webRoot: /app/docroot\n")),Object(i.b)("p",null,"If you change this, make sure to check for any other references to ",Object(i.b)("inlineCode",{parentName:"p"},"/app/web")," or ",Object(i.b)("inlineCode",{parentName:"p"},"web")," in your project."),Object(i.b)("p",null,"Some known references are:"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"public-files")," mount in this the Drupal chart (values.yaml file)"),Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"silta/nginx.Dockerfile")),Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"composer.json")," & ",Object(i.b)("inlineCode",{parentName:"li"},"composer.lock")),Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},".dockerignore")),Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},".gitignore")),Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},".lando.yml")),Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"grumphp.yml")),Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"phpcs.xml"))),Object(i.b)("p",null,"You also need to add the following in ",Object(i.b)("inlineCode",{parentName:"p"},".circleci/config.yml")," parameters and put your webRoot directory name as the value, for example ",Object(i.b)("inlineCode",{parentName:"p"},"web")," or ",Object(i.b)("inlineCode",{parentName:"p"},"docroot"),":"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},"Add parameter ",Object(i.b)("inlineCode",{parentName:"li"},"web-root")," to ",Object(i.b)("inlineCode",{parentName:"li"},"silta/drupal-validate")," job"),Object(i.b)("li",{parentName:"ul"},"Add parameter ",Object(i.b)("inlineCode",{parentName:"li"},"nginx_build_context")," to ",Object(i.b)("inlineCode",{parentName:"li"},"silta/drupal-deploy-build")," job")),Object(i.b)("h2",{id:"how-to-customize-container-images-of-silta-deployments"},"How to customize container images of Silta deployments?"),Object(i.b)("p",null,"Drupal chart requires 3 images by default, ",Object(i.b)("inlineCode",{parentName:"p"},"nginx")," image, ",Object(i.b)("inlineCode",{parentName:"p"},"php")," and ",Object(i.b)("inlineCode",{parentName:"p"},"shell")," image. Source Dockerfiles for the image building are located at ",Object(i.b)("inlineCode",{parentName:"p"},"silta/nginx.Dockerfile"),", ",Object(i.b)("inlineCode",{parentName:"p"},"silta/php.Dockerfile")," and ",Object(i.b)("inlineCode",{parentName:"p"},"silta/shell.Dockerfile")," by default."),Object(i.b)("p",null,"Frontend chart dockerfiles depend on services You want to deploy. Normally the dockerfiles are located in ",Object(i.b)("inlineCode",{parentName:"p"},"silta/")," directory, i.e. ",Object(i.b)("inlineCode",{parentName:"p"},"silta/node.Dockerfile"),"."),Object(i.b)("p",null,"These dockerfiles use specially crafted base images that provide additional libraries and tools by default. See upstream image sources at ",Object(i.b)("a",{parentName:"p",href:"https://github.com/wunderio/silta-images"},"https://github.com/wunderio/silta-images"),".   "),Object(i.b)("p",null,"You can install extra tools for Your project by editing dockerfiles. Let's use shell container as an example:"),Object(i.b)("p",null,"Content of ",Object(i.b)("a",{parentName:"p",href:"https://github.com/wunderio/drupal-project/blob/master/silta/shell.Dockerfile"},"silta/shell.Dockerfile"),":"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre"},"# Dockerfile for the Shell container.\nFROM wunderio/silta-php-shell:php7.4-v0.1\n\nCOPY --chown=www-data:www-data . /app\n")),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},"The ",Object(i.b)("inlineCode",{parentName:"li"},"FROM")," instruction initializes a new build stage and sets the Base Image for subsequent instructions. As such, a valid Dockerfile must start with a FROM instruction. The image can be any valid image \u2013 it is especially easy to start by pulling an image from the Public Repositories. In this  example it uses wunderio shell image, tagged with ",Object(i.b)("inlineCode",{parentName:"li"},"php7.4-v0.1")," tag. "),Object(i.b)("li",{parentName:"ul"},"The ",Object(i.b)("inlineCode",{parentName:"li"},"COPY")," instruction copies new files or directories from ",Object(i.b)("inlineCode",{parentName:"li"},".")," (project's root folder, but this can be adjusted) and adds them to the filesystem of the container at the path ",Object(i.b)("inlineCode",{parentName:"li"},"/app"))),Object(i.b)("p",null,"If You need to copy extra files or install tools, You can add extra instructions, f.ex -"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre"},"COPY --chown=bin files* /somedir/\n\nRUN apk add wget\n")),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},"The RUN instruction will execute any commands in a new layer on top of the current image and commit the results. The resulting committed image will be used for the next step in the Dockerfile.")),Object(i.b)("p",null,"See Dockerfile refrence for more instructions: ",Object(i.b)("a",{parentName:"p",href:"https://docs.docker.com/engine/reference/builder/"},"https://docs.docker.com/engine/reference/builder/")),Object(i.b)("h2",{id:"q-how-to-test-docker-images"},"Q: How to test docker images?"),Object(i.b)("p",null,"If You want to test docker images locally, You'd need to install docker or other runtime that allows running docker images. This tutorial won't list instructions for that and will assume You can run ",Object(i.b)("inlineCode",{parentName:"p"},"docker")," command (it also needs to be at least version 20.10 to be able to run alpine 3.14+ images. ",Object(i.b)("a",{parentName:"p",href:"https://wiki.alpinelinux.org/wiki/Release_Notes_for_Alpine_3.14.0#faccessat2"},"Related document"),")."),Object(i.b)("p",null,"Running a docker image:"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-bash"},"docker run -it --entrypoint sh wunderio/silta-php-shell:php7.4-v0.1\n")),Object(i.b)("p",null,"This will download shell image and run a shell inside it. Typing ",Object(i.b)("inlineCode",{parentName:"p"},"exit")," will quit and stop the container."),Object(i.b)("p",null,"This also allows running other images like nginx:"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-bash"},"# running official nginx image from https://hub.docker.com/_/nginx \ndocker run -p 8080:80 nginx \n")),Object(i.b)("p",null,'This way You can also run silta images, as long as You have access to image repository. See "',Object(i.b)("a",{parentName:"p",href:"#q-how-to-run-silta-images-locally"},"How to run silta image locally"),'" for instructions.'),Object(i.b)("p",null,"If You want to test your customized dockerfile, You need to build the image and run it"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-bash"},"# Build image and tag it with `shell_test_build` tag\ndocker build -t shell_test_build -f silta/shell.Dockerfile .\n# Run tagged image and and exec into it with `sh` shell \ndocker run -it --entrypoint  sh shell_test_build\n# Remove test image\ndocker image rm shell_test_build\n")),Object(i.b)("p",null,'More about running docker images via docker cli at "',Object(i.b)("a",{parentName:"p",href:"https://docs.docker.com/engine/reference/commandline/cli/"},"Docker Command-line reference"),'" '),Object(i.b)("h2",{id:"q-how-to-run-silta-images-locally"},"Q: How to run Silta images locally?"),Object(i.b)("p",null,"TLDR: You can run those images locally, but there are missing resources (storage mounts, environment variables, secrets) that are only available in the cluster. You can still run containers and debug node applications if You have to."),Object(i.b)("p",null,"If You want to run some silta image locally for debugging or other purpose, follow these steps:"),Object(i.b)("ol",null,Object(i.b)("li",{parentName:"ol"},Object(i.b)("p",{parentName:"li"},"Make sure You have access to kubernetes cluster. "),Object(i.b)("ul",{parentName:"li"},Object(i.b)("li",{parentName:"ul"},"Install kubectl kubernetes cli tool: ",Object(i.b)("a",{parentName:"li",href:"https://kubernetes.io/docs/tasks/tools/"},"https://kubernetes.io/docs/tasks/tools/")),Object(i.b)("li",{parentName:"ul"},"Configure cluster access for kubectl (when using Google Kubernetes Engine): ",Object(i.b)("a",{parentName:"li",href:"https://cloud.google.com/kubernetes-engine/docs/how-to/cluster-access-for-kubectl"},"https://cloud.google.com/kubernetes-engine/docs/how-to/cluster-access-for-kubectl")),Object(i.b)("li",{parentName:"ul"},"Try listing pod resources as an example (replace ",Object(i.b)("inlineCode",{parentName:"li"},"drupal-project-k8s")," with your repository name) ",Object(i.b)("pre",{parentName:"li"},Object(i.b)("code",{parentName:"pre",className:"language-bash"},"kubectl get pods -n drupal-project-k8s\n"))))),Object(i.b)("li",{parentName:"ol"},Object(i.b)("p",{parentName:"li"},"Get the docker image URL for the container You are need to run using kubectl:"),Object(i.b)("pre",{parentName:"li"},Object(i.b)("code",{parentName:"pre",className:"language-bash"},"$ kubectl get deployments -o wide -n drupal-project-k8s\nNAME                 READY   UP-TO-DATE   AVAILABLE   AGE     CONTAINERS        IMAGES                                                                                                                                                                                    SELECTOR\nmaster-drupal        1/1     1            1           448d    php,nginx         eu.gcr.io/[gcp-project]/drupal-project-k8s-php:v5-76e9f99eb3c4293fa14184b546bc1af980ea3760,eu.gcr.io/[gcp-project]/drupal-project-k8s-nginx:v5-bef5cba1137eaaa73a986bad07221bbab3ae5ca2   app=drupal,deployment=drupal,release=master\nmaster-shell         1/1     1            1           448d    shell             eu.gcr.io/[gcp-project]/drupal-project-k8s-shell:v6-3879d81221f34e79ff8674efca539c8d7410dd0a                                                                                              app=drupal,release=master,service=shell\n\n")),Object(i.b)("ul",{parentName:"li"},Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"drupal-project-k8s")," is kubernetes namespace, in Silta it's also a project name."),Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"master-drupal")," is drupal pod of ",Object(i.b)("inlineCode",{parentName:"li"},"master")," branch deployment"),Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"master-drupal")," pod contains two containers, ",Object(i.b)("inlineCode",{parentName:"li"},"nginx")," and ",Object(i.b)("inlineCode",{parentName:"li"},"drupal"),'. These containers are using two images (see "IMAGES" column). See Google Kubernetes Engine ',Object(i.b)("a",{parentName:"li",href:"https://cloud.google.com/kubernetes-engine/docs/concepts/pod"},"Pod documentation"),' if you need to grasp the "Pod" concept. Pod resource is not GKE exclusive, this documentation applies to all kubernetes clusters.'),Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"master-shell")," is a shell pod for ",Object(i.b)("inlineCode",{parentName:"li"},"master")," branch deployment."))),Object(i.b)("li",{parentName:"ol"},Object(i.b)("p",{parentName:"li"},"Make sure You have image pull access. Try pulling it:"),Object(i.b)("pre",{parentName:"li"},Object(i.b)("code",{parentName:"pre",className:"language-bash"},"docker pull eu.gcr.io/[gcp-project]/drupal-project-k8s-shell:v6-3879d81221f34e79ff8674efca539c8d7410dd0a\n")),Object(i.b)("ul",{parentName:"li"},Object(i.b)("li",{parentName:"ul"},"If it fails, authenticate with Container Registry using gcloud helper: ",Object(i.b)("a",{parentName:"li",href:"https://cloud.google.com/container-registry/docs/advanced-authentication#gcloud-helper"},"https://cloud.google.com/container-registry/docs/advanced-authentication#gcloud-helper"),Object(i.b)("pre",{parentName:"li"},Object(i.b)("code",{parentName:"pre",className:"language-bash"},"  gcloud auth login\n  gcloud auth configure-docker\n"))))),Object(i.b)("li",{parentName:"ol"},Object(i.b)("p",{parentName:"li"},"Run Silta ",Object(i.b)("inlineCode",{parentName:"p"},"shell")," image:"),Object(i.b)("pre",{parentName:"li"},Object(i.b)("code",{parentName:"pre",className:"language-bash"},"docker run -it --entrypoint sh eu.gcr.io/[gcp-project]/drupal-project-k8s-shell:v6-3879d81221f34e79ff8674efca539c8d7410dd0a\n")),Object(i.b)("ul",{parentName:"li"},Object(i.b)("li",{parentName:"ul"},"You can't run nginx image properly in local environment because silta mounts resources (storage, secrets, environment variables) that are only available in the cluster"),Object(i.b)("li",{parentName:"ul"},"There will be some resources (mounts) missing in shell container (i.e. no content in ",Object(i.b)("inlineCode",{parentName:"li"},"sites/default/files"),") and some environment variables missing.")))))}b.isMDXComponent=!0}}]);