(window.webpackJsonp=window.webpackJsonp||[]).push([[12],{106:function(e,n,t){"use strict";t.d(n,"a",(function(){return b})),t.d(n,"b",(function(){return u}));var a=t(0),r=t.n(a);function i(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function o(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function s(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?o(Object(t),!0).forEach((function(n){i(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):o(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function l(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)t=i[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)t=i[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var c=r.a.createContext({}),p=function(e){var n=r.a.useContext(c),t=n;return e&&(t="function"==typeof e?e(n):s(s({},n),e)),t},b=function(e){var n=p(e.components);return r.a.createElement(c.Provider,{value:n},e.children)},d={inlineCode:"code",wrapper:function(e){var n=e.children;return r.a.createElement(r.a.Fragment,{},n)}},m=r.a.forwardRef((function(e,n){var t=e.components,a=e.mdxType,i=e.originalType,o=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),b=p(t),m=a,u=b["".concat(o,".").concat(m)]||b[m]||d[m]||i;return t?r.a.createElement(u,s(s({ref:n},c),{},{components:t})):r.a.createElement(u,s({ref:n},c))}));function u(e,n){var t=arguments,a=n&&n.mdxType;if("string"==typeof e||a){var i=t.length,o=new Array(i);o[0]=m;var s={};for(var l in n)hasOwnProperty.call(n,l)&&(s[l]=n[l]);s.originalType=e,s.mdxType="string"==typeof e?e:a,o[1]=s;for(var c=2;c<i;c++)o[c]=t[c];return r.a.createElement.apply(null,o)}return r.a.createElement.apply(null,t)}m.displayName="MDXCreateElement"},81:function(e,n,t){"use strict";t.r(n),t.d(n,"frontMatter",(function(){return o})),t.d(n,"metadata",(function(){return s})),t.d(n,"toc",(function(){return l})),t.d(n,"default",(function(){return p}));var a=t(3),r=t(7),i=(t(0),t(106)),o={id:"silta-examples",title:"Silta examples"},s={unversionedId:"silta-examples",id:"silta-examples",isDocsHomePage:!1,title:"Silta examples",description:"silta.yml configuration examples",source:"@site/docs/silta-examples.md",slug:"/silta-examples",permalink:"/silta/docs/silta-examples",editUrl:"https://github.com/wunderio/silta/tree/master/docs/silta-examples.md",version:"current",sidebar:"someSidebar",previous:{title:"Configuring CDN",permalink:"/silta/docs/configuring-cdn"},next:{title:"Troubleshooting and FAQ",permalink:"/silta/docs/troubleshooting"}},l=[{value:"silta.yml configuration examples",id:"siltayml-configuration-examples",children:[]},{value:"Allocate more storage for your database.",id:"allocate-more-storage-for-your-database",children:[]},{value:"Using different version of MariaDB than provided in chart defaults.",id:"using-different-version-of-mariadb-than-provided-in-chart-defaults",children:[]},{value:"Mount Drupal public files to a different location",id:"mount-drupal-public-files-to-a-different-location",children:[]},{value:"Enabling private files for drupal",id:"enabling-private-files-for-drupal",children:[]},{value:"Change how often the standard Drupal cron is executed",id:"change-how-often-the-standard-drupal-cron-is-executed",children:[]},{value:"Deploy a custom service using frontend chart",id:"deploy-a-custom-service-using-frontend-chart",children:[]},{value:"Run a custom cron job",id:"run-a-custom-cron-job",children:[]},{value:"Add additional environment variables",id:"add-additional-environment-variables",children:[]},{value:"Change basic auth username and password",id:"change-basic-auth-username-and-password",children:[]},{value:"Enable elasticsearch",id:"enable-elasticsearch",children:[]},{value:"Using plugins with Elasticsearch",id:"using-plugins-with-elasticsearch",children:[]},{value:"Enable memcached",id:"enable-memcached",children:[]},{value:"Using varnish",id:"using-varnish",children:[]},{value:"Using Redis",id:"using-redis",children:[]},{value:"Skip taking reference data dumps on each deployment",id:"skip-taking-reference-data-dumps-on-each-deployment",children:[]},{value:"Sending e-mail",id:"sending-e-mail",children:[]},{value:"Domain names and SSL certificates",id:"domain-names-and-ssl-certificates",children:[]},{value:"Add redirects",id:"add-redirects",children:[]},{value:"Allowing cross-namespace / cross-deployment connections",id:"allowing-cross-namespace--cross-deployment-connections",children:[]},{value:"Configure security context for frontend services",id:"configure-security-context-for-frontend-services",children:[{value:"Security Context Properties",id:"security-context-properties",children:[]},{value:"Common Use Cases",id:"common-use-cases",children:[]}]},{value:"Add custom include files for nginx",id:"add-custom-include-files-for-nginx",children:[]},{value:"Deploy sub-project from the same repo using simple chart",id:"deploy-sub-project-from-the-same-repo-using-simple-chart",children:[]},{value:"Add custom subcharts to deployment",id:"add-custom-subcharts-to-deployment",children:[]}],c={toc:l};function p(e){var n=e.components,t=Object(r.a)(e,["components"]);return Object(i.b)("wrapper",Object(a.a)({},c,t,{components:n,mdxType:"MDXLayout"}),Object(i.b)("h2",{id:"siltayml-configuration-examples"},"silta.yml configuration examples"),Object(i.b)("p",null,"The default values are documented here:"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},"Drupal chart: ",Object(i.b)("a",{parentName:"li",href:"https://github.com/wunderio/charts/blob/master/drupal/values.yaml"},"https://github.com/wunderio/charts/blob/master/drupal/values.yaml")),Object(i.b)("li",{parentName:"ul"},"Frontend chart: ",Object(i.b)("a",{parentName:"li",href:"https://github.com/wunderio/charts/blob/master/frontend/values.yaml"},"https://github.com/wunderio/charts/blob/master/frontend/values.yaml")),Object(i.b)("li",{parentName:"ul"},"Simple chart: ",Object(i.b)("a",{parentName:"li",href:"https://github.com/wunderio/charts/blob/master/simple/values.yaml"},"https://github.com/wunderio/charts/blob/master/simple/values.yaml"))),Object(i.b)("p",null,"Below is a list of examples for common needs.\nAll examples are meant to be used in the ",Object(i.b)("inlineCode",{parentName:"p"},"silta.yml")," file of your project. Most of the examples work with both drupal chart and frontend chart, unless name is explicitly mentioned above the code snippet. Double-check with default value files for each chart - ",Object(i.b)("a",{parentName:"p",href:"https://github.com/wunderio/charts/blob/master/drupal/values.yaml"},"drupal")," and ",Object(i.b)("a",{parentName:"p",href:"https://github.com/wunderio/charts/blob/master/frontend/values.yaml"},"frontend"),"."),Object(i.b)("p",null,"Also note that increasing resources will result in increased costs, so use sensible values."),Object(i.b)("h2",{id:"allocate-more-storage-for-your-database"},"Allocate more storage for your database."),Object(i.b)("p",null,Object(i.b)("em",{parentName:"p"},"Drupal chart"),":"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-yaml"},"mariadb:\n  master:\n    persistence:\n      size: 2G\n")),Object(i.b)("p",null,"Note that storage can only be increased, not decreased."),Object(i.b)("p",null,"Note 2: If you change it for existing deployment, You'll need to run special comands in cluster to expand the storage or deployment will fail (see ",Object(i.b)("a",{parentName:"p",href:"/silta/docs/troubleshooting#mariadb-or-elasticsearch-running-out-of-disk-space"},"Mariadb or Elasticsearch running out of disk space")," in troubleshooting page)."),Object(i.b)("h2",{id:"using-different-version-of-mariadb-than-provided-in-chart-defaults"},"Using different version of MariaDB than provided in chart defaults."),Object(i.b)("p",null,"While it's normally not advised, it's possible to adjust MariaDB image version -"),Object(i.b)("p",null,Object(i.b)("em",{parentName:"p"},"Drupal chart and Frontend chart"),":"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-yaml"},"mariadb:\n  image:\n    # Available image tags listed at https://hub.docker.com/r/bitnami/mariadb/tags. Use debian images.\n    # tag: 10.10.6-debian-11-r25\n    # tag: 10.11.5-debian-11-r24\n    tag: 11.0.3-debian-11-r25\n")),Object(i.b)("p",null,"It's highly suggested to create mysql data backup before image change."),Object(i.b)("p",null,"Note: Do not change image to an earlier version, it may break the data."),Object(i.b)("h2",{id:"mount-drupal-public-files-to-a-different-location"},"Mount Drupal public files to a different location"),Object(i.b)("p",null,Object(i.b)("em",{parentName:"p"},"Drupal chart"),":"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-yaml"},"mounts:\n  public-files:\n    mountPath: `/app/web/sites/my-other-location/files`\n")),Object(i.b)("h2",{id:"enabling-private-files-for-drupal"},"Enabling private files for drupal"),Object(i.b)("p",null,"There is a pre-built mount template for drupal private file storage in silta (check values.yaml), you just have to enable it"),Object(i.b)("p",null,Object(i.b)("em",{parentName:"p"},"Drupal chart"),":"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-yaml"},"mounts:\n  private-files:\n    enabled: true\n")),Object(i.b)("p",null,"Enabling this will mount shared storage to ",Object(i.b)("inlineCode",{parentName:"p"},"/app/private")," and set ",Object(i.b)("inlineCode",{parentName:"p"},"$settings['file_private_path']")," accordingly. See chart values for override parameters."),Object(i.b)("h2",{id:"change-how-often-the-standard-drupal-cron-is-executed"},"Change how often the standard Drupal cron is executed"),Object(i.b)("p",null,Object(i.b)("em",{parentName:"p"},"Drupal chart"),":"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-yaml"},'php:\n  cron:\n    drupal:\n      # Run every 5 minutes\n      schedule: "*/5 * * * *"\n')),Object(i.b)("h2",{id:"deploy-a-custom-service-using-frontend-chart"},"Deploy a custom service using frontend chart"),Object(i.b)("p",null,'While Frontend chart was originally meant to host NodeJS frontend projects, it also allows running custom docker images and optionally exposing them via nginx reverse proxy. These containers are called "services" in Frontend chart.'),Object(i.b)("p",null,'In this example, we are setting up two custom services - "mynodeservice" that will use a custom built image (see circleci configuration below) and "mongo" that will use prebuilt mongodb docker imageservice.'),Object(i.b)("p",null,'Note: This ".Values.services.mongo" service is not the same as ".Values.mongodb", it\'s just an example.'),Object(i.b)("p",null,Object(i.b)("em",{parentName:"p"},"Frontend chart"),":"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-yaml"},'services:\n  mynodeservice:\n    replicas: 1\n    port: 3000\n    env:\n      VARIABLE: "VALUE"\n    # Exposed at [hostname]/servicepath\n    exposedRoute: "/servicepath"\n\n  mongo:\n    # Mongo image does not need to be built,\n    # uses https://hub.docker.com/_/mongo\n    image: mongo\n    port: 27017\n')),Object(i.b)("p",null,"See ",Object(i.b)("inlineCode",{parentName:"p"},".Values.serviceDefaults")," for service default values."),Object(i.b)("p",null,"Service images are built at ",Object(i.b)("inlineCode",{parentName:"p"},".circleci/config.yaml"),":"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-yaml"},'workflows:\n  build_deploy:\n    jobs:\n      - silta/frontend-build-deploy: &build-deploy\n          image_build_steps:\n            - silta/build-docker-image:\n                dockerfile: "silta/mynodeservice.Dockerfile"\n                path: "."\n                identifier: "mynodeservice"\n')),Object(i.b)("p",null,"It is very important to understand kubernetes containers are stateless, the moment container gets restarted, it will reset the storage to contents of docker image. To persist some particular filesystem path, you need to define persistent storage at ",Object(i.b)("inlineCode",{parentName:"p"},".Values.mounts")," and attach it to the service (this only applies to containers defined at ",Object(i.b)("inlineCode",{parentName:"p"},".Values.services")," since other applications (",Object(i.b)("inlineCode",{parentName:"p"},".Values.mongodb"),", ",Object(i.b)("inlineCode",{parentName:"p"},".Values.mariadb"),", etc.) have default configurations in chart that persist data)."),Object(i.b)("p",null,'In this example, we are setting up a custom "mongo" service that will use prebuilt mongodb docker imageservice.'),Object(i.b)("p",null,'Note: This ".Values.services.mongo" service is not the same as ".Values.mongodb", it\'s just an example.'),Object(i.b)("p",null,Object(i.b)("em",{parentName:"p"},"Frontend chart"),":"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-yaml"},"services:\n  mongo:\n    # Mongo image does not need to be built,\n    # uses https://hub.docker.com/_/mongo\n    image: mongo\n    port: 27017\n    mounts:\n      - mongodb-data\n    strategy:\n      type: Recreate\n\nmounts:\n  mongodb-data:\n    enabled: true\n    storage: 5Gi\n    mountPath: /data/db\n    # GKE storage class\n    storageClassName: standard\n    accessModes: ReadWriteOnce\n")),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"storageClassName")," is only available on GKE. AWS and other cloud providers have different storageclasses, so it depends on cloud provider. There are several options and they differ by access (read / write) speed. ",Object(i.b)("inlineCode",{parentName:"li"},"standard")," is a safe choice."),Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"accessModes")," depends on storageClass. ",Object(i.b)("inlineCode",{parentName:"li"},"standard")," on GKE provides ",Object(i.b)("inlineCode",{parentName:"li"},"ReadWriteOnce"),". See ",Object(i.b)("a",{parentName:"li",href:"https://kubernetes.io/docs/concepts/storage/persistent-volumes/#access-modes"},"https://kubernetes.io/docs/concepts/storage/persistent-volumes/#access-modes")," for more information"),Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},".Values.services.mongo.strategy.type: Recreate"),' is required for "read write once" type storage mounts, because they only allow mounting storage once, but default strategy for services is ',Object(i.b)("inlineCode",{parentName:"li"},"RollingUpdate")," and it would fail deployment. See ",Object(i.b)("a",{parentName:"li",href:"https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#strategy"},"https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#strategy")," for more information.")),Object(i.b)("h2",{id:"run-a-custom-cron-job"},"Run a custom cron job"),Object(i.b)("p",null,Object(i.b)("em",{parentName:"p"},"Drupal chart"),":"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-yaml"},'php:\n  cron:\n    my-custom-cron-job:\n      # Run a custom drush command at midnight\n      schedule: "0 0 * * *"\n      command: "drush my-custom-command"\n')),Object(i.b)("p",null,Object(i.b)("em",{parentName:"p"},"Frontend chart"),":"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-yaml"},'services:\n  myservice:\n    cron:\n      my-custom-cron-job:\n        # Run a custom command at midnight\n        schedule: "0 0 * * *"\n        command: "my-custom-command"\n')),Object(i.b)("h2",{id:"add-additional-environment-variables"},"Add additional environment variables"),Object(i.b)("p",null,Object(i.b)("em",{parentName:"p"},"Drupal chart"),":"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-yaml"},'php:\n  env:\n    MY_VARIABLE_NAME: "theValueOfMyVariable"\n')),Object(i.b)("p",null,Object(i.b)("em",{parentName:"p"},"Frontend chart"),":"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-yaml"},'services:\n  myservice:\n    env:\n      MY_VARIABLE_NAME: "theValueOfMyVariable"\n')),Object(i.b)("h2",{id:"change-basic-auth-username-and-password"},"Change basic auth username and password"),Object(i.b)("p",null,Object(i.b)("em",{parentName:"p"},"Drupal chart and Frontend chart"),":"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-yaml"},"nginx:\n  basicauth:\n    credentials:\n      username: hello\n      password: My$ecretP4ssw0rd\n")),Object(i.b)("h2",{id:"enable-elasticsearch"},"Enable elasticsearch"),Object(i.b)("p",null,Object(i.b)("em",{parentName:"p"},"Drupal chart and Frontend chart"),":"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-yaml"},"elasticsearch:\n  enabled: true\n")),Object(i.b)("h2",{id:"using-plugins-with-elasticsearch"},"Using plugins with Elasticsearch"),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"Create a custom elasticsearch dockerfile to silta/elasticsearch.Dockerfile:")),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre"},"ARG ES_VERSION=7.17.0\nFROM docker.elastic.co/elasticsearch/elasticsearch:${ES_VERSION}\nARG ES_VERSION\n\nUSER root\n\n# Install Elasticsearch plugins\nRUN elasticsearch-plugin install analysis-icu\n\nUSER elasticsearch\n")),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"Build the custom Elasticsearch image in CircleCI:")),Object(i.b)("p",null,"When using ",Object(i.b)("inlineCode",{parentName:"p"},"silta/drupal-build-deploy"),":"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre"},"      - silta/drupal-build-deploy:\n          pre-release:\n            - silta/build-docker-image:\n                dockerfile: silta/elasticsearch.Dockerfile\n                tag: with-plugins\n                identifier: elasticsearch\n                expose_image: false\n")),Object(i.b)("p",null,"When using ",Object(i.b)("inlineCode",{parentName:"p"},"silta/frontend-build-deploy"),":"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre"},"      - silta/frontend-build-deploy:\n          image_build_steps:\n            - silta/build-docker-image:\n                dockerfile: silta/elasticsearch.Dockerfile\n                tag: with-plugins\n                identifier: elasticsearch\n                expose_image: false\n")),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"Use the custom elasticsearch image in your silta helm charts file:")),Object(i.b)("p",null,"The container URL could be found in the CircleCI container build information."),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre"},"elasticsearch:\n  enabled: true\n  image: <CONTAINER-URL>\n  imageTag: 'with-plugins'\n  imagePullPolicy: Always\n")),Object(i.b)("h2",{id:"enable-memcached"},"Enable memcached"),Object(i.b)("p",null,Object(i.b)("em",{parentName:"p"},"Drupal chart"),":"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-yaml"},"memcached:\n  enabled: true\n")),Object(i.b)("p",null,"Adjust resources and arguments as needed"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre"},"  resources:\n    requests:\n      cpu: 150m\n      memory: 1200M\n    limits:\n      cpu: 250m\n      memory: 1500M\n  arguments:\n    - /run.sh\n    # MaxMemoryLimit, this should be less than the resources.limits.memory, or memcached will crash.\n    - -m 1200\n    # MaxItemSize\n    - -I 16M\n")),Object(i.b)("p",null,"Modify settings.php file (example is from D9)"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre"},"/**\n * Set the memcache server hostname when a memcached server is available.\n */\nif (getenv(\"SILTA_CLUSTER\") && getenv('MEMCACHED_HOST')) {\n  $settings['memcache']['servers'] = [getenv('MEMCACHED_HOST') . ':11211' => 'default'];\n\n  // Set the default cache backend to use memcache if memcache host is set and\n  // if one of the memcache libraries was found. Cache backends should not be\n  // set to memcache during installation. The existence of the memcache drupal\n  // module should also be checked but this is not possible until this issue\n  // has been fixed: https://www.drupal.org/project/drupal/issues/2766509\n  if (!InstallerKernel::installationAttempted() && (class_exists('Memcache', FALSE) || class_exists('Memcached', FALSE))) {\n    $settings['cache']['default'] = 'cache.backend.memcache';\n  }\n\n  /**\n   * Memcache configuration.\n   */\n  if (class_exists('Memcached', FALSE)) {\n    $settings['memcache']['extension'] = 'Memcached';\n    // Memcached PECL Extension Support.\n    $settings['memcache']['options'] = [\n      // Enable compression for PHP 7.\n      \\Memcached::OPT_COMPRESSION => TRUE,\n      \\Memcached::OPT_DISTRIBUTION => \\Memcached::DISTRIBUTION_CONSISTENT,\n      // Decrease latency.\n      \\Memcached::OPT_TCP_NODELAY => TRUE,\n    ];\n  }\n}\n")),Object(i.b)("p",null,"For D7 use"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre"},"  if (getenv('MEMCACHED_HOST')) {\n    if (class_exists('Memcache', FALSE) || class_exists('Memcached', FALSE)) {\n      $conf['memcache_servers'] = [getenv('MEMCACHED_HOST') . ':11211' => 'default'];\n    }\n  }\n")),Object(i.b)("h2",{id:"using-varnish"},"Using varnish"),Object(i.b)("p",null,Object(i.b)("em",{parentName:"p"},"Drupal chart"),":"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-yaml"},"varnish:\n  enabled: true\n")),Object(i.b)("p",null,"If extra cookies are needed, they can be defined in a vcl_extra_cookies variable:"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-yaml"},'varnish:\n  vcl_extra_cookies: |\n    if (req.http.Cookie ~ "extra_cookie_name") {\n      return (pass);\n    }\n')),Object(i.b)("p",null,"When varnish is enabled in silta config, drupal configuration needs to be adjusted, so purge can find the varnish server."),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"Using ",Object(i.b)("a",{parentName:"strong",href:"https://www.drupal.org/project/varnish"},"varnish")," module:")),Object(i.b)("p",null,Object(i.b)("em",{parentName:"p"},"You should consider using purge module instead"),"\nNo adjustments needed"),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"Using ",Object(i.b)("a",{parentName:"strong",href:"https://www.drupal.org/project/varnish_purge"},"varnish_purge")," module:")),Object(i.b)("ol",null,Object(i.b)("li",{parentName:"ol"},"Add varnish purger to purge settings."),Object(i.b)("li",{parentName:"ol"},"Find purger configuration name. You can see it by hovering over the configuration link (i.e. ",Object(i.b)("inlineCode",{parentName:"li"},"1b619ba479"),"). This will be Your ",Object(i.b)("inlineCode",{parentName:"li"},"<PURGER_ID>"),"."),Object(i.b)("li",{parentName:"ol"},"Put this snippet into your ",Object(i.b)("inlineCode",{parentName:"li"},"settings.php")," file:")),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-php"},"if (getenv('SILTA_CLUSTER') && getenv('VARNISH_ADMIN_HOST')) {\n  $config['varnish_purger.settings.<PURGER_ID>']['hostname'] = trim(getenv('VARNISH_ADMIN_HOST'));\n  $config['varnish_purger.settings.<PURGER_ID>']['port'] = '80';\n}\n")),Object(i.b)("p",null,"Make sure to replace ",Object(i.b)("inlineCode",{parentName:"p"},"<PURGER_ID>")," with an actual id of purger configuration!"),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"Changing varnish default control-key value")),Object(i.b)("p",null,"This can be done by adding ",Object(i.b)("inlineCode",{parentName:"p"},"secret")," variable."),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-yaml"},'varnish:\n  secret: "my-secret-key"\n')),Object(i.b)("p",null,"Please remember: best practice is to encrypt secrets."),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"Changing varnish cache backend")),Object(i.b)("p",null,"The current default cache backend is set to file storage. The setting is exposed in values file and can be changed. Here are few examples:"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-yaml"},"varnish:\n  resources:\n    requests:\n      memory: 768Mi\n  # Memory allocated storage. Make sure to adjust varnish memory allocation too (see above)\n  storageBackend: 'malloc,512m'\n  # Disc allocated storage.\n  storageBackend: 'file,/var/lib/varnish/varnish_storage.bin,512M'\n")),Object(i.b)("h2",{id:"using-redis"},"Using Redis"),Object(i.b)("p",null,"By default, redis service does not set max memory value. You can do it by setting flags:"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-yaml"},'redis:\n  enabled: true\n  master:\n    persistence:\n      size: 2Gi\n    extraFlags:\n      - "--maxmemory-policy allkeys-lru"\n      - "--maxmemory 1700mb"\n')),Object(i.b)("h2",{id:"skip-taking-reference-data-dumps-on-each-deployment"},"Skip taking reference data dumps on each deployment"),Object(i.b)("p",null,Object(i.b)("em",{parentName:"p"},"Drupal chart"),":"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-yaml"},"referenceData:\n  updateAfterDeployment: false\n")),Object(i.b)("p",null,"For some sites with a lot of files, taking a reference data dump after each deployment can cause the builds to time out. Disabling ",Object(i.b)("inlineCode",{parentName:"p"},"updateAfterDeployment")," means new environments will be created with reference data from the previous nightly dump."),Object(i.b)("h2",{id:"sending-e-mail"},"Sending e-mail"),Object(i.b)("p",null,"Note: There is no e-mail handling for frontend chart. You must implement the smtp workflow via application."),Object(i.b)("p",null,"If you just want to test email, you can use mailhog:"),Object(i.b)("p",null,Object(i.b)("em",{parentName:"p"},"Drupal chart"),":"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-yaml"},"mailhog:\n  enabled: true\n")),Object(i.b)("p",null,"Mailhog access information will be printed in release notes."),Object(i.b)("p",null,"\u26a0\ufe0f ",Object(i.b)("strong",{parentName:"p"},"Deprecated"),": ",Object(i.b)("em",{parentName:"p"},"mailhog")," will be removed from future releases, use ",Object(i.b)("em",{parentName:"p"},"mailpit")," instead (see below)"),Object(i.b)("hr",null),Object(i.b)("p",null,"To enabled mailpit in Drupal or Frontend charts use:"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-yaml"},"mailpit:\n  enabled: true\n")),Object(i.b)("p",null,"Mailpit access information will be printed in release notes."),Object(i.b)("hr",null),Object(i.b)("p",null,"For emails to be actually sent out of the cluster, you can use any external smtp server. Here's an example for sparkpost."),Object(i.b)("p",null,Object(i.b)("em",{parentName:"p"},"Drupal chart"),":"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-yaml"},'smtp:\n  enabled: true\n  address: smtp.sparkpostmail.com:587 # or smtp.eu.sparkpost.com:587\n  tls: true\n  # When using smtp.office365.com:587 instead of sparkpost both tls and starttls need to be set to "YES".\n  # tls: "YES"\n  # starttls: "YES"\n  username: "SMTP_Injection"\n  # Encrypt this password. See: docs/encrypting_sensitive_configuration.md\n  # Please note that when using smtp.office365.com:587, password may not contain following special characters =, :, or #\n  password: "MYAPIKEY"\n')),Object(i.b)("p",null,"Note: To get the sparkpost API key, you have to ",Object(i.b)("a",{parentName:"p",href:"https://www.sparkpost.com/docs/getting-started/setting-up-domains/"},"validate your domain")," first."),Object(i.b)("p",null,"Note 2: Because of ",Object(i.b)("a",{parentName:"p",href:"https://serverfault.com/questions/826875/what-characters-are-illegal-in-password-in-ssmtp-conf"},"long-standing bugs in the ssmtp package"),", the smtp password cannot contain the special characters ",Object(i.b)("inlineCode",{parentName:"p"},"#"),", ",Object(i.b)("inlineCode",{parentName:"p"},"=")," or ",Object(i.b)("inlineCode",{parentName:"p"},":"),"."),Object(i.b)("p",null,"If the ",Object(i.b)("inlineCode",{parentName:"p"},"smtp")," is configured and enabled, but it does not appear to send anything, make sure ",Object(i.b)("inlineCode",{parentName:"p"},"mailhog")," or ",Object(i.b)("inlineCode",{parentName:"p"},"mailpit")," is not enabled."),Object(i.b)("h2",{id:"domain-names-and-ssl-certificates"},"Domain names and SSL certificates"),Object(i.b)("p",null,"All environments are given a hostname by default. It is possible to attach a custom domain name to environment by configuring ",Object(i.b)("inlineCode",{parentName:"p"},"exposeDomains")," configuration parameter. All hostnames attached to environment are printed in release notes.\nYou can also use ",Object(i.b)("inlineCode",{parentName:"p"},"letsencrypt-staging")," issuer to avoid hitting ",Object(i.b)("inlineCode",{parentName:"p"},"letsencrypt")," ",Object(i.b)("a",{parentName:"p",href:"https://letsencrypt.org/docs/rate-limits/"},"rate limits"),"."),Object(i.b)("p",null,"!NB Deploy ",Object(i.b)("inlineCode",{parentName:"p"},"exposeDomains")," entries only when DNS entries are changed or are soon to be changed. Otherwise, Letsencrypt validation might eventually get stuck due to retries."),Object(i.b)("p",null,"!NB Put ",Object(i.b)("inlineCode",{parentName:"p"},"exposeDomains")," in a dedicated configuration yaml file, so only one environment (branch) would be assigned this hostname. Having multiple environments with the same domain will act as a round robin load balancer for all environments and unexpected responses might be returned."),Object(i.b)("p",null,Object(i.b)("em",{parentName:"p"},"Drupal chart and Frontend chart"),":"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-yaml"},"exposeDomains:\n  example-le:\n    hostname: ssl-le.example.com\n    ssl:\n      enabled: true\n      issuer: letsencrypt\n\n  example-customcert:\n    hostname: ssl-custom.example.com\n    ssl:\n      enabled: true\n      issuer: custom\n      # Encrypt key and certificate. See: docs/encrypting_sensitive_configuration.md\n      key: |\n        -----BEGIN RSA PRIVATE KEY-----\n        <KEY>\n        -----END RSA PRIVATE KEY-----\n      crt: |\n        -----BEGIN CERTIFICATE-----\n        < DOMAIN CERTIFICATE >\n        -----END CERTIFICATE-----\n        -----BEGIN CERTIFICATE-----\n        < INTERMEDIATE CERTIFICATE >\n        -----END CERTIFICATE-----\n        -----BEGIN CERTIFICATE-----\n        < ROOT CA CERTIFICATE >\n        -----END CERTIFICATE-----\n")),Object(i.b)("p",null,Object(i.b)("inlineCode",{parentName:"p"},"key")," value is certificates private key.\n",Object(i.b)("inlineCode",{parentName:"p"},"crt")," value is full chain of certificate.\n",Object(i.b)("inlineCode",{parentName:"p"},"ca")," value is not required anymore for exposed domains.\n",Object(i.b)("a",{parentName:"p",href:"/silta/docs/ssl_certificates"},"See more information on how to convert and prepare SSL certificate for exposed domains")),Object(i.b)("p",null,"If you have same SSL certificate for multiple domains You can reuse ",Object(i.b)("inlineCode",{parentName:"p"},"ssl")," block."),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-yaml"},"exposeDomains:\n  example-domain1: &shared-ssl\n    ssl:\n      [....]\n  example-domain2:\n    <<: *shared-ssl\n  example-domain3:\n    <<: *shared-ssl\n")),Object(i.b)("p",null,"You don't need a custom static ip (via gce ingress) normally, but if Your project requires, here's how -"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-yaml"},'exposeDomains:\n  example-gce-ingress:\n    hostname: gce-ingress.example.com\n    # see ingress.gce definition. This can also be a custom ingress too.\n    ingress: gce\n    ssl:\n      enabled: true\n      issuer: letsencrypt\n\ningress:\n  gce:\n    # Request a global static ip from OPS team first\n    staticIpAddressName: custom-ip-name\n\nnginx:\n  # Reverse proxy IP\'s to trust with contents of X-Forwarded-For header\n  realipfrom:\n    gke-internal: 10.0.0.0/8\n    # Load Balancer IP (static ip you were given)\n    gce-lb-ip: 1.2.3.4/32;\n\n# Depending on the cluster type, You might need to enable this.\n# A safe default is "false" (works in both cases), but "VPC Native"\n# clusters work more correcly with cluster.vpcNative set to "true".\ncluster:\n  vpcNative: true\n')),Object(i.b)("h2",{id:"add-redirects"},"Add redirects"),Object(i.b)("p",null,"Redirects can be relative to current domain or contain full domain for more targeted redirects when multiple external domains (",Object(i.b)("inlineCode",{parentName:"p"},"exposeDomains"),") are attached to deployment, and you only need this redirect for a specific URL."),Object(i.b)("p",null,"If you are scattering the redirect rules into separate yaml's, use keys (or the latter yaml will overwrite the whole ",Object(i.b)("inlineCode",{parentName:"p"},"nginx.redirects")," object) and the alphabetical order of keys will be respected in the nginx redirect map. Because of this, it's better to put everything in one file without keys, just descriptions and the order of the yaml will be respected."),Object(i.b)("p",null,"Each redirect has ",Object(i.b)("inlineCode",{parentName:"p"},"from")," and ",Object(i.b)("inlineCode",{parentName:"p"},"to")," keys, and an optional ",Object(i.b)("inlineCode",{parentName:"p"},"description")," key, which does not do anything currently, it's a documentation comment for configuration maintainer."),Object(i.b)("h4",{id:"from"},Object(i.b)("inlineCode",{parentName:"h4"},"from")),Object(i.b)("p",null,"By default, strings are matched using case-insensitive exact matching."),Object(i.b)("p",null,"Regular expressions can be used by prefixing the value with ",Object(i.b)("inlineCode",{parentName:"p"},"~")," for a case-sensitive matching, or with ",Object(i.b)("inlineCode",{parentName:"p"},"~*")," for case-insensitive matching. Regular expressions can contain named and positional captures that can be referenced in the ",Object(i.b)("inlineCode",{parentName:"p"},"to")," value."),Object(i.b)("p",null,"Make sure to use proper anchors (",Object(i.b)("inlineCode",{parentName:"p"},"^")," and ",Object(i.b)("inlineCode",{parentName:"p"},"$"),") and character escaping in regular expressions, to get exactly the match you want and nothing extra."),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},"Bad example: ",Object(i.b)("inlineCode",{parentName:"li"},"from: '~/old-page")," matches any string containing ",Object(i.b)("inlineCode",{parentName:"li"},"/old-page"),", e.g. ",Object(i.b)("inlineCode",{parentName:"li"},"/anypath/old-page")," or ",Object(i.b)("inlineCode",{parentName:"li"},"/old-page/anypath")," or even ",Object(i.b)("inlineCode",{parentName:"li"},"/valid/path?/old-page"),"."),Object(i.b)("li",{parentName:"ul"},"Good example: ",Object(i.b)("inlineCode",{parentName:"li"},"from: ~^/old-page/.+\\.html")," matches specifically path ",Object(i.b)("inlineCode",{parentName:"li"},"/old-page/*.html"),".")),Object(i.b)("h4",{id:"to"},Object(i.b)("inlineCode",{parentName:"h4"},"to")),Object(i.b)("p",null,"Can include references to captured values from regular expressions, and special ",Object(i.b)("a",{parentName:"p",href:"http://nginx.org/en/docs/http/ngx_http_core_module.html#variables"},"nginx variables")," like ",Object(i.b)("inlineCode",{parentName:"p"},"$request_uri"),"or ",Object(i.b)("inlineCode",{parentName:"p"},"$query_string"),"."),Object(i.b)("p",null,Object(i.b)("em",{parentName:"p"},"Drupal chart and Frontend chart"),":"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-yaml"},"nginx:\n  redirects:\n    - description: 'Redirect exact path match to another path on same the domain.'\n      from: '/old-page'\n      to: '/new-page'\n    - description: 'Redirect exact path match to another path on another the domain.'\n      from: '/old-page'\n      to: 'https://another-domain.example.com/new-page'\n    - description: 'Redirect exact url match to another path on same the domain. Note: Matching using https does not work because of SSL/TLS offloading.'\n      from: 'http://example.com/old-page'\n      to: '/new-page'\n    - description: 'Redirect all non-www requests to www, keeping the request path intact.'\n      from: '~^http://example\\.com'\n      to: 'https://www.example.com$request_uri'\n    - description: 'Redirect exact url, matching both www and non-www.'\n      from: '~http://(www\\.)?example\\.com/old-page$'\n      to: '/new-page'\n    - description: 'Redirect case-insensitive url match.'\n      from: '~*http://www\\.example\\.com/oLd-pAgE$'\n      to: '/new-page'\n    - description: 'Redirect regex match, using positional capturing groups.'\n      from: '~^/old-articles/(.+)/view/(\\d+)$'\n      to: '/new-articles/$1/?article_id=$2'\n    - description: 'Redirect regex match, using named capturing groups.'\n      from: '~^/old-articles/(?<date>.+)/view/(?<id>\\d+)$'\n      to: '/new-articles/$date/?article_id=$id'\n\n")),Object(i.b)("h2",{id:"allowing-cross-namespace--cross-deployment-connections"},"Allowing cross-namespace / cross-deployment connections"),Object(i.b)("p",null,"Resources in Silta charts are protected by ",Object(i.b)("a",{parentName:"p",href:"https://projectcalico.docs.tigera.io/security/calico-network-policy"},"Calico NetworkPolicy")," rules. Rules are defined in helm ",Object(i.b)("inlineCode",{parentName:"p"},".Values.silta-release.ingressAccess")," configuration object. There are few default rules that deny access to all pods in deployment from other deployments, but it is also possible to add extra ","[NetworkPolicy rules]"," (",Object(i.b)("a",{parentName:"p",href:"https://projectcalico.docs.tigera.io/security/policy-rules"},"https://projectcalico.docs.tigera.io/security/policy-rules"),") to selecively allow access to deployment resources."),Object(i.b)("p",null,"Here are few examples:"),Object(i.b)("ol",null,Object(i.b)("li",{parentName:"ol"},"Allowing access to pods from another namespace:")),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-yaml"},"silta-release:\n  ingressAccess:\n    # Allow Frontend access to Drupal via internal connection\n    allow-drupal:\n      additionalPodSelector:\n        app: drupal\n      from:\n        - namespaceSelector:\n            matchLabels:\n              name: frontend-ns\n")),Object(i.b)("ol",{start:2},Object(i.b)("li",{parentName:"ol"},"Allow direct elasticsearch access from frontend namespace")),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre"},"silta-release:\n  # Allow Frontend access to elasticsearch via internal connection\n  allowESaccess:\n    additionalPodSelector:\n      chart: elasticsearch\n    from:\n      - namespaceSelector:\n          matchLabels:\n              name: frontend-ns\n")),Object(i.b)("ol",{start:3},Object(i.b)("li",{parentName:"ol"},"Allow CIDR access to service (routed connection only, does not work with NAT'ted connections)")),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-yaml"},"silta-release:\n  # Allow Azure Application Gateway to drupal service\n  ingressAccess:\n    CustomAzureAppGWAccess:\n      from:\n        - ipBlock:\n            cidr: 1.2.3.4/5\n")),Object(i.b)("h2",{id:"configure-security-context-for-frontend-services"},"Configure security context for frontend services"),Object(i.b)("p",null,Object(i.b)("em",{parentName:"p"},"Frontend chart"),":"),Object(i.b)("p",null,"Each individual service in the frontend chart can have its own security context configuration to enhance the security of your containers. The ",Object(i.b)("inlineCode",{parentName:"p"},"securityContext")," configuration allows you to control various security-related settings for your containers, including user/group permissions, Linux capabilities, and security profiles."),Object(i.b)("p",null,"Security contexts are crucial for implementing the principle of least privilege in your containerized applications, helping to minimize the potential impact of security vulnerabilities."),Object(i.b)("h3",{id:"security-context-properties"},"Security Context Properties"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-yaml"},'services:\n  myservice:\n    securityContext:\n      # Controls whether a process can gain more privileges than its parent process\n      # Setting this to false ensures that no child process of the container can\n      # gain more privileges than the container itself\n      allowPrivilegeEscalation: false\n\n      # Makes the container\'s root filesystem read-only, preventing\n      # modifications to the container\'s filesystem at runtime\n      # This helps prevent malicious or accidental modifications\n      readOnlyRootFilesystem: true\n\n      # Forces the container to run as a non-root user\n      # This is a key security practice to reduce the impact of container breakouts\n      runAsNonRoot: true\n\n      # Specifies the user ID (UID) that processes in the container will run as\n      # Using a non-zero value ensures processes don\'t run as root (UID 0)\n      runAsUser: 1000\n\n      # Specifies the primary group ID (GID) for processes in the container\n      runAsGroup: 1000\n\n      # Sets the group ID for filesystem operations\n      # This is used for volume mounts and file creation\n      fsGroup: 1000\n\n      # Controls whether the container runs in privileged mode\n      # Privileged containers have nearly all the capabilities of the host machine\n      # This should almost always be set to false for security reasons\n      privileged: false\n\n      # Configures how proc is mounted in the container\n      # Options: "Default" or "Unmasked"\n      # "Default" is the standard masked proc mount\n      # "Unmasked" is less secure but may be required for certain applications\n      procMount: "Default"\n\n      # Linux capabilities provide fine-grained control over privileged operations\n      capabilities:\n        # Capabilities to add to the container\n        # Only add capabilities that are absolutely necessary\n        add:\n          # Allows binding to ports below 1024 without root privileges\n          - "NET_BIND_SERVICE"\n          # Other examples of capabilities:\n          # - "CHOWN" - Allows changing file ownership\n          # - "FOWNER" - Bypass permission checks on operations that normally require the filesystem UID to match the process\'s UID\n          # - "SETGID" - Make arbitrary manipulations of process GIDs\n          # - "SETUID" - Make arbitrary manipulations of process UIDs\n\n        # Capabilities to remove from the container\n        # It\'s a best practice to drop all capabilities and only add those needed\n        drop:\n          - "ALL"\n\n      # Seccomp (secure computing mode) profile configuration\n      # Seccomp restricts the system calls that a container can make\n      seccompProfile:\n        # Type of seccomp profile to use\n        # Options: "RuntimeDefault", "Localhost", or "Unconfined"\n        # "RuntimeDefault" uses the container runtime\'s default profile\n        # "Localhost" uses a profile defined on the host\n        # "Unconfined" disables seccomp restrictions (not recommended)\n        type: "RuntimeDefault"\n        # Path to a seccomp profile on the host when type is "Localhost"\n        localhostProfile: "my-profiles/profile-allow.json"\n\n      # SELinux (Security-Enhanced Linux) options\n      # These control the SELinux context of the container\n      seLinuxOptions:\n        # SELinux level label\n        level: "s0:c123,c456"\n        # SELinux role label\n        role: "object_r"\n        # SELinux type label\n        type: "spc_t"\n        # SELinux user label\n        user: "system_u"\n\n      # Sysctls allow setting kernel parameters at runtime\n      # These are applied to the container\'s namespace\n      sysctls:\n        - name: "kernel.shm_rmid_forced"\n          value: "0"\n        - name: "net.core.somaxconn"\n          value: "1024"\n        # Other examples:\n        # - name: "net.ipv4.ip_local_port_range"\n        #   value: "1024 65535"\n        # - name: "kernel.msgmax"\n        #   value: "65536"\n')),Object(i.b)("h3",{id:"common-use-cases"},"Common Use Cases"),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"Web server running on port 80:")),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-yaml"},'securityContext:\n  allowPrivilegeEscalation: false\n  readOnlyRootFilesystem: true\n  runAsNonRoot: true\n  runAsUser: 1000\n  capabilities:\n    add: ["NET_BIND_SERVICE"]\n    drop: ["ALL"]\n')),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"Application requiring file ownership changes:")),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-yaml"},'securityContext:\n  runAsNonRoot: true\n  runAsUser: 1000\n  capabilities:\n    add: ["CHOWN"]\n    drop: ["ALL"]\n')),Object(i.b)("h2",{id:"add-custom-include-files-for-nginx"},"Add custom include files for nginx"),Object(i.b)("p",null,"Drupal chart builds nginx container using web/ folder as build context. This prevents files being included from outside the web folder and it's not a good idea to put config files under it.\nTo be able to add include files the build context needs to be changed from ",Object(i.b)("inlineCode",{parentName:"p"},"web/")," into ",Object(i.b)("inlineCode",{parentName:"p"},".")," by passing ",Object(i.b)("inlineCode",{parentName:"p"},'nginx_build_context: "."')," to ",Object(i.b)("inlineCode",{parentName:"p"},"drupal-docker-build")," in ",Object(i.b)("inlineCode",{parentName:"p"},".circleci/config.yml"),":"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-yaml"},'jobs:\n  - silta/drupal-docker-build:\n      nginx_build_context: "."\n')),Object(i.b)("p",null,"Due root containing Drupal / shell container compatible .dockerignore file and for frontend there is a separate one inside the web/ folder this doesn't work anymore. Since version 19.03 Docker supports separate .dockerignore files for each Dockerfile. This requires Docker build to be made with BuildKit enabled. To enable BuildKit just pass the ",Object(i.b)("inlineCode",{parentName:"p"},"DOCKER_BUILDKIT=1")," to the build environment as an environment variable:"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-yaml"},"environment:\n  DOCKER_BUILDKIT: 1\n")),Object(i.b)("p",null,"The ignore file itself needs to be named the same as the Dockerfile with .dockerignore appended to the end and need to reside at the same place as the Dockerfile:"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-bash"},"cp web/.gitignore silta/nginx.Dockerfile.dockerignore\n")),Object(i.b)("p",null,"Note: our validation checks if the .dockerignore is present under web/ so you can either leave it there or just add an empty file in it's place.\nTo make the image to build correctly in this new context you need to update the COPY command in the nginx.Dockerfile to copy ",Object(i.b)("inlineCode",{parentName:"p"},"web")," instead of ",Object(i.b)("inlineCode",{parentName:"p"},".")," and also add COPY commands to any custom config files you want to be able to include:"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre"},"COPY silta/nginx.serverextra.conf /etc/nginx\n\nCOPY web /app/web\n")),Object(i.b)("p",null,"Now you can include the config file in silta.yml like this:"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-yaml"},"nginx:\n  serverExtraConfig: |\n    include nginx.serverextra.conf;\n")),Object(i.b)("p",null,"or if you ",Object(i.b)("inlineCode",{parentName:"p"},"COPY")," the file under ",Object(i.b)("inlineCode",{parentName:"p"},"/etc/nginx/conf.d")," they will be included automatically without the need to add them to silta.yml configs."),Object(i.b)("h2",{id:"deploy-sub-project-from-the-same-repo-using-simple-chart"},"Deploy sub-project from the same repo using simple chart"),Object(i.b)("p",null,"Having e.g. Storybook or other frontend application included in the base project codebase that require\nseparate deployment can be easily done even using different chart.\nSee ",Object(i.b)("a",{parentName:"p",href:"/silta/docs/circleci-conf-examples"},"https://wunderio.github.io/silta/docs/circleci-conf-examples")," for the deployment setup part."),Object(i.b)("p",null,"When using different charts (e.g. drupal and simple) you need to separate chart specific configurations to their own silta-","*",".yml files if you want to share any configs between the application deployments (for example basic auth credentials). Best way to do it is to put only the shared configurations to the silta.yml file and have e.g. silta-cms.yml and silta-storybook.yml for application specific configurations."),Object(i.b)("h2",{id:"add-custom-subcharts-to-deployment"},"Add custom subcharts to deployment"),Object(i.b)("ol",null,Object(i.b)("li",{parentName:"ol"},"In ",Object(i.b)("inlineCode",{parentName:"li"},"silta")," folder, create ",Object(i.b)("inlineCode",{parentName:"li"},"extra_charts.yml")," which contains list of subcharts to add.")),Object(i.b)("p",null,"Following examples add a redis subchart to drupal chart deployment."),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-yaml"},"charts:\n- name: redis\n  version: 16.8.x\n  repository: https://charts.bitnami.com/bitnami\n  condition: redis.enabled\n")),Object(i.b)("p",null,"To use a local subchart, replace repository link with ",Object(i.b)("inlineCode",{parentName:"p"},"file://<path>/<to>/<subchart>")),Object(i.b)("ol",{start:2},Object(i.b)("li",{parentName:"ol"},"Add these 2 parameters to ",Object(i.b)("inlineCode",{parentName:"li"},"drupal-deploy")," CircleCI job:")),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-yaml"},"      - silta/drupal-deploy:\n          source_chart: wunderio/drupal\n          extension_file: silta/extra_charts.yml\n")),Object(i.b)("ol",{start:3},Object(i.b)("li",{parentName:"ol"},"If desired, modify variables for the subchart in ",Object(i.b)("inlineCode",{parentName:"li"},"silta.yml")," under the key of subcharts' name. For example above, it's ",Object(i.b)("inlineCode",{parentName:"li"},"redis"),".")),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-yaml"},"[..]\nredis:\n  enabled: true\n  auth:\n    password: test\n")),Object(i.b)("p",null,Object(i.b)("em",{parentName:"p"},"Sets redis password to test")),Object(i.b)("p",null,"Notice the ",Object(i.b)("inlineCode",{parentName:"p"},"condition")," key in ",Object(i.b)("inlineCode",{parentName:"p"},"extra_charts.yml")," for the redis subchart. It makes it possible to deploy this subchart conditionally, when ",Object(i.b)("inlineCode",{parentName:"p"},"redis: enabled")," is passed in ",Object(i.b)("inlineCode",{parentName:"p"},"silta.yml"),"."),Object(i.b)("p",null,"Delete the ",Object(i.b)("inlineCode",{parentName:"p"},"condition: redis.enabled")," line if you want this subchart installed in all your future deployments, regardless of settings in ",Object(i.b)("inlineCode",{parentName:"p"},"silta.yml"),"."))}p.isMDXComponent=!0}}]);